import debounce from 'debounce-promise';
import { LogLevel } from '@aws-amplify/cli-core';
/**
 * Execute CDK commands.
 */
export class AmplifySandboxExecutor {
    backendDeployer;
    secretClient;
    printer;
    /**
     * Function that invokes the callback with debounce.
     * Debounce is needed in case multiple duplicate events are received.
     */
    invoke = debounce(async (callback) => await callback(), 100);
    /**
     * Creates an AmplifySandboxExecutor instance
     */
    constructor(backendDeployer, secretClient, printer) {
        this.backendDeployer = backendDeployer;
        this.secretClient = secretClient;
        this.printer = printer;
    }
    /**
     * Deploys sandbox
     */
    deploy = async (backendId, validateAppSourcesProvider) => {
        this.printer.log('[Sandbox] Executing command `deploy`', LogLevel.DEBUG);
        const secretLastUpdated = await this.getSecretLastUpdated(backendId);
        return this.invoke(() => {
            // it's important to get information here so that information
            // doesn't get lost while debouncing
            const validateAppSources = validateAppSourcesProvider();
            return this.backendDeployer.deploy(backendId, {
                secretLastUpdated,
                validateAppSources,
            });
        });
    };
    /**
     * Destroy sandbox. Do not swallow errors
     */
    destroy = (backendId) => {
        this.printer.log('[Sandbox] Executing command `destroy`', LogLevel.DEBUG);
        return this.invoke(() => this.backendDeployer.destroy(backendId));
    };
    getSecretLastUpdated = async (backendId) => {
        const secrets = await this.secretClient.listSecrets(backendId);
        let latestTimestamp = -1;
        let secretLastUpdate;
        secrets.forEach((secret) => {
            if (!secret.lastUpdated) {
                return;
            }
            const curTimeStamp = secret.lastUpdated.getTime();
            if (curTimeStamp > 0 && curTimeStamp > latestTimestamp) {
                latestTimestamp = curTimeStamp;
                secretLastUpdate = secret.lastUpdated;
            }
        });
        return secretLastUpdate;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveF9leGVjdXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zYW5kYm94X2V4ZWN1dG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sUUFBUSxNQUFNLGtCQUFrQixDQUFDO0FBUXhDLE9BQU8sRUFBRSxRQUFRLEVBQVcsTUFBTSx1QkFBdUIsQ0FBQztBQUUxRDs7R0FFRztBQUNILE1BQU0sT0FBTyxzQkFBc0I7SUFnQmQ7SUFDQTtJQUNBO0lBakJuQjs7O09BR0c7SUFDSyxNQUFNLEdBQUcsUUFBUSxDQUN2QixLQUFLLEVBQ0gsUUFBcUQsRUFDZCxFQUFFLENBQUMsTUFBTSxRQUFRLEVBQUUsRUFDNUQsR0FBRyxDQUNKLENBQUM7SUFFRjs7T0FFRztJQUNILFlBQ21CLGVBQWdDLEVBQ2hDLFlBQTBCLEVBQzFCLE9BQWdCO1FBRmhCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixZQUFPLEdBQVAsT0FBTyxDQUFTO0lBQ2hDLENBQUM7SUFFSjs7T0FFRztJQUNILE1BQU0sR0FBRyxLQUFLLEVBQ1osU0FBNEIsRUFDNUIsMEJBQXlDLEVBQ2xCLEVBQUU7UUFDekIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0NBQXNDLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pFLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFckUsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRTtZQUN0Qiw2REFBNkQ7WUFDN0Qsb0NBQW9DO1lBQ3BDLE1BQU0sa0JBQWtCLEdBQUcsMEJBQTBCLEVBQUUsQ0FBQztZQUN4RCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRTtnQkFDNUMsaUJBQWlCO2dCQUNqQixrQkFBa0I7YUFDbkIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILE9BQU8sR0FBRyxDQUFDLFNBQTRCLEVBQTBCLEVBQUU7UUFDakUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUNBQXVDLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFFLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQ3BFLENBQUMsQ0FBQztJQUVNLG9CQUFvQixHQUFHLEtBQUssRUFDbEMsU0FBNEIsRUFDRCxFQUFFO1FBQzdCLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDL0QsSUFBSSxlQUFlLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDekIsSUFBSSxnQkFBa0MsQ0FBQztRQUV2QyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDekIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUU7Z0JBQ3ZCLE9BQU87YUFDUjtZQUNELE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDbEQsSUFBSSxZQUFZLEdBQUcsQ0FBQyxJQUFJLFlBQVksR0FBRyxlQUFlLEVBQUU7Z0JBQ3RELGVBQWUsR0FBRyxZQUFZLENBQUM7Z0JBQy9CLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUM7YUFDdkM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZGVib3VuY2UgZnJvbSAnZGVib3VuY2UtcHJvbWlzZSc7XG5pbXBvcnQgeyBCYWNrZW5kSWRlbnRpZmllciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQmFja2VuZERlcGxveWVyLFxuICBEZXBsb3lSZXN1bHQsXG4gIERlc3Ryb3lSZXN1bHQsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLWRlcGxveWVyJztcbmltcG9ydCB7IFNlY3JldENsaWVudCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLXNlY3JldCc7XG5pbXBvcnQgeyBMb2dMZXZlbCwgUHJpbnRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGktY29yZSc7XG5cbi8qKlxuICogRXhlY3V0ZSBDREsgY29tbWFuZHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5U2FuZGJveEV4ZWN1dG9yIHtcbiAgLyoqXG4gICAqIEZ1bmN0aW9uIHRoYXQgaW52b2tlcyB0aGUgY2FsbGJhY2sgd2l0aCBkZWJvdW5jZS5cbiAgICogRGVib3VuY2UgaXMgbmVlZGVkIGluIGNhc2UgbXVsdGlwbGUgZHVwbGljYXRlIGV2ZW50cyBhcmUgcmVjZWl2ZWQuXG4gICAqL1xuICBwcml2YXRlIGludm9rZSA9IGRlYm91bmNlKFxuICAgIGFzeW5jIChcbiAgICAgIGNhbGxiYWNrOiAoKSA9PiBQcm9taXNlPERlcGxveVJlc3VsdCB8IERlc3Ryb3lSZXN1bHQ+XG4gICAgKTogUHJvbWlzZTxEZXBsb3lSZXN1bHQgfCBEZXN0cm95UmVzdWx0PiA9PiBhd2FpdCBjYWxsYmFjaygpLFxuICAgIDEwMFxuICApO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuIEFtcGxpZnlTYW5kYm94RXhlY3V0b3IgaW5zdGFuY2VcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2VuZERlcGxveWVyOiBCYWNrZW5kRGVwbG95ZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzZWNyZXRDbGllbnQ6IFNlY3JldENsaWVudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaW50ZXI6IFByaW50ZXJcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBEZXBsb3lzIHNhbmRib3hcbiAgICovXG4gIGRlcGxveSA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWQ6IEJhY2tlbmRJZGVudGlmaWVyLFxuICAgIHZhbGlkYXRlQXBwU291cmNlc1Byb3ZpZGVyOiAoKSA9PiBib29sZWFuXG4gICk6IFByb21pc2U8RGVwbG95UmVzdWx0PiA9PiB7XG4gICAgdGhpcy5wcmludGVyLmxvZygnW1NhbmRib3hdIEV4ZWN1dGluZyBjb21tYW5kIGBkZXBsb3lgJywgTG9nTGV2ZWwuREVCVUcpO1xuICAgIGNvbnN0IHNlY3JldExhc3RVcGRhdGVkID0gYXdhaXQgdGhpcy5nZXRTZWNyZXRMYXN0VXBkYXRlZChiYWNrZW5kSWQpO1xuXG4gICAgcmV0dXJuIHRoaXMuaW52b2tlKCgpID0+IHtcbiAgICAgIC8vIGl0J3MgaW1wb3J0YW50IHRvIGdldCBpbmZvcm1hdGlvbiBoZXJlIHNvIHRoYXQgaW5mb3JtYXRpb25cbiAgICAgIC8vIGRvZXNuJ3QgZ2V0IGxvc3Qgd2hpbGUgZGVib3VuY2luZ1xuICAgICAgY29uc3QgdmFsaWRhdGVBcHBTb3VyY2VzID0gdmFsaWRhdGVBcHBTb3VyY2VzUHJvdmlkZXIoKTtcbiAgICAgIHJldHVybiB0aGlzLmJhY2tlbmREZXBsb3llci5kZXBsb3koYmFja2VuZElkLCB7XG4gICAgICAgIHNlY3JldExhc3RVcGRhdGVkLFxuICAgICAgICB2YWxpZGF0ZUFwcFNvdXJjZXMsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfTtcblxuICAvKipcbiAgICogRGVzdHJveSBzYW5kYm94LiBEbyBub3Qgc3dhbGxvdyBlcnJvcnNcbiAgICovXG4gIGRlc3Ryb3kgPSAoYmFja2VuZElkOiBCYWNrZW5kSWRlbnRpZmllcik6IFByb21pc2U8RGVzdHJveVJlc3VsdD4gPT4ge1xuICAgIHRoaXMucHJpbnRlci5sb2coJ1tTYW5kYm94XSBFeGVjdXRpbmcgY29tbWFuZCBgZGVzdHJveWAnLCBMb2dMZXZlbC5ERUJVRyk7XG4gICAgcmV0dXJuIHRoaXMuaW52b2tlKCgpID0+IHRoaXMuYmFja2VuZERlcGxveWVyLmRlc3Ryb3koYmFja2VuZElkKSk7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRTZWNyZXRMYXN0VXBkYXRlZCA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWQ6IEJhY2tlbmRJZGVudGlmaWVyXG4gICk6IFByb21pc2U8RGF0ZSB8IHVuZGVmaW5lZD4gPT4ge1xuICAgIGNvbnN0IHNlY3JldHMgPSBhd2FpdCB0aGlzLnNlY3JldENsaWVudC5saXN0U2VjcmV0cyhiYWNrZW5kSWQpO1xuICAgIGxldCBsYXRlc3RUaW1lc3RhbXAgPSAtMTtcbiAgICBsZXQgc2VjcmV0TGFzdFVwZGF0ZTogRGF0ZSB8IHVuZGVmaW5lZDtcblxuICAgIHNlY3JldHMuZm9yRWFjaCgoc2VjcmV0KSA9PiB7XG4gICAgICBpZiAoIXNlY3JldC5sYXN0VXBkYXRlZCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCBjdXJUaW1lU3RhbXAgPSBzZWNyZXQubGFzdFVwZGF0ZWQuZ2V0VGltZSgpO1xuICAgICAgaWYgKGN1clRpbWVTdGFtcCA+IDAgJiYgY3VyVGltZVN0YW1wID4gbGF0ZXN0VGltZXN0YW1wKSB7XG4gICAgICAgIGxhdGVzdFRpbWVzdGFtcCA9IGN1clRpbWVTdGFtcDtcbiAgICAgICAgc2VjcmV0TGFzdFVwZGF0ZSA9IHNlY3JldC5sYXN0VXBkYXRlZDtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBzZWNyZXRMYXN0VXBkYXRlO1xuICB9O1xufVxuIl19