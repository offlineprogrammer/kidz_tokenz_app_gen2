import { BackendIdentifierConversions } from '@aws-amplify/platform-core';
import { BackendOutputClientErrorType, } from './backend_output_client_factory.js';
import { DeleteStackCommand, DescribeStacksCommand, ListStackResourcesCommand, ListStacksCommand, StackStatus, } from '@aws-sdk/client-cloudformation';
import { GetObjectCommand } from '@aws-sdk/client-s3';
import { authOutputKey, graphqlOutputKey, platformOutputKey, storageOutputKey, } from '@aws-amplify/backend-output-schemas';
/**
 * Deployment Client
 */
export class DefaultDeployedBackendClient {
    cfnClient;
    s3Client;
    backendOutputClient;
    deployedResourcesEnumerator;
    stackStatusMapper;
    arnParser;
    /**
     * Constructor for deployment client
     */
    constructor(cfnClient, s3Client, backendOutputClient, deployedResourcesEnumerator, stackStatusMapper, arnParser) {
        this.cfnClient = cfnClient;
        this.s3Client = s3Client;
        this.backendOutputClient = backendOutputClient;
        this.deployedResourcesEnumerator = deployedResourcesEnumerator;
        this.stackStatusMapper = stackStatusMapper;
        this.arnParser = arnParser;
    }
    /**
     * Deletes a sandbox with the specified id
     */
    deleteSandbox = async (sandboxBackendIdentifier) => {
        const stackName = BackendIdentifierConversions.toStackName({
            ...sandboxBackendIdentifier,
            type: 'sandbox',
        });
        await this.cfnClient.send(new DeleteStackCommand({ StackName: stackName }));
    };
    /**
     * Fetches all backend metadata for a specified backend
     */
    getBackendMetadata = async (backendId) => {
        const stackName = BackendIdentifierConversions.toStackName(backendId);
        return this.buildBackendMetadata(stackName);
    };
    /**
     * Returns Amplify Sandboxes for the account and region. The number of sandboxes returned can vary
     */
    listSandboxes = async (listSandboxesRequest) => {
        const stackMetadata = [];
        let nextToken = listSandboxesRequest?.nextToken;
        do {
            const listStacksResponse = await this.listStacks(nextToken);
            const stackMetadataPromises = listStacksResponse.stackSummaries
                .filter((stackSummary) => {
                return stackSummary.StackStatus !== StackStatus.DELETE_COMPLETE;
            })
                .filter((stackSummary) => {
                return this.isSandboxStack(stackSummary.StackName);
            })
                .map(async (stackSummary) => {
                const deploymentType = await this.tryGetDeploymentType(stackSummary);
                return {
                    name: stackSummary.StackName,
                    backendId: BackendIdentifierConversions.fromStackName(stackSummary.StackName),
                    lastUpdated: stackSummary.LastUpdatedTime ?? stackSummary.CreationTime,
                    status: this.stackStatusMapper.translateStackStatus(stackSummary.StackStatus),
                    deploymentType,
                };
            });
            const stackMetadataResolvedPromises = await Promise.all(stackMetadataPromises);
            const filteredMetadata = stackMetadataResolvedPromises.filter((stackMetadata) => stackMetadata.deploymentType === 'sandbox');
            stackMetadata.push(...filteredMetadata);
            nextToken = listStacksResponse.nextToken;
        } while (stackMetadata.length === 0 && nextToken);
        return {
            sandboxes: stackMetadata,
            nextToken,
        };
    };
    isSandboxStack = (stackName) => {
        const backendIdentifier = BackendIdentifierConversions.fromStackName(stackName);
        return backendIdentifier?.type === 'sandbox';
    };
    tryGetDeploymentType = async (stackSummary) => {
        const backendIdentifier = {
            stackName: stackSummary.StackName,
        };
        try {
            const backendOutput = await this.backendOutputClient.getOutput(backendIdentifier);
            return backendOutput[platformOutputKey].payload
                .deploymentType;
        }
        catch (error) {
            if (error.code ===
                BackendOutputClientErrorType.METADATA_RETRIEVAL_ERROR) {
                // Ignore stacks where metadata cannot be retrieved. These are not Amplify stacks, or not compatible with this library.
                return;
            }
            throw error;
        }
    };
    listStacks = async (nextToken) => {
        const stacks = await this.cfnClient.send(new ListStacksCommand({ NextToken: nextToken }));
        nextToken = stacks.NextToken;
        return { stackSummaries: stacks.StackSummaries ?? [], nextToken };
    };
    buildBackendMetadata = async (stackName) => {
        const stackBackendIdentifier = {
            stackName,
        };
        const backendOutput = await this.backendOutputClient.getOutput(stackBackendIdentifier);
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackName }));
        const stack = stackDescription?.Stacks?.[0];
        const status = this.stackStatusMapper.translateStackStatus(stack?.StackStatus);
        const lastUpdated = stack?.LastUpdatedTime ?? stack?.CreationTime;
        const stackResources = await this.cfnClient.send(new ListStackResourcesCommand({
            StackName: stackName,
        }));
        const childStackPromises = stackResources.StackResourceSummaries?.filter((stackResourceSummary) => {
            return (stackResourceSummary.ResourceType === 'AWS::CloudFormation::Stack');
        }).map(async (stackResourceSummary) => {
            // arn:aws:{service}:{region}:{account}:stack/{stackName}/{additionalFields}
            const arnParts = stackResourceSummary.PhysicalResourceId?.split('/');
            const childStackName = arnParts?.[1];
            if (!childStackName) {
                return;
            }
            const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: childStackName }));
            const stack = stackDescription?.Stacks?.[0];
            return stack;
        }) ?? [];
        const childStacks = await Promise.all(childStackPromises);
        const authStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('auth'));
        const storageStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('storage'));
        const apiStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('data'));
        // stack?.StackId is the ARN of the stack
        const { accountId, region } = this.arnParser.tryParseArn(stack?.StackId);
        const backendMetadataObject = {
            deploymentType: backendOutput[platformOutputKey].payload
                .deploymentType,
            lastUpdated,
            status,
            name: stackName,
            resources: await this.deployedResourcesEnumerator.listDeployedResources(this.cfnClient, stackName, accountId, region),
        };
        if (authStack) {
            backendMetadataObject.authConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(authStack.StackStatus),
                lastUpdated: authStack.LastUpdatedTime ?? authStack.CreationTime,
                userPoolId: backendOutput[authOutputKey]?.payload.userPoolId,
            };
        }
        if (storageStack) {
            backendMetadataObject.storageConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(storageStack.StackStatus),
                lastUpdated: storageStack.LastUpdatedTime ?? storageStack.CreationTime,
                s3BucketName: backendOutput[storageOutputKey]?.payload
                    .bucketName,
            };
        }
        if (apiStack) {
            const additionalAuthTypesString = backendOutput[graphqlOutputKey]?.payload
                .awsAppsyncAdditionalAuthenticationTypes;
            const additionalAuthTypes = additionalAuthTypesString
                ? additionalAuthTypesString.split(',')
                : [];
            backendMetadataObject.apiConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(apiStack.StackStatus),
                lastUpdated: apiStack.LastUpdatedTime ?? apiStack.CreationTime,
                graphqlEndpoint: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncApiEndpoint,
                defaultAuthType: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncAuthenticationType,
                additionalAuthTypes,
                conflictResolutionMode: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncConflictResolutionMode,
                apiId: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncApiId,
            };
        }
        return backendMetadataObject;
    };
    fetchSchema = async (schemaS3Uri) => {
        if (!schemaS3Uri) {
            throw new Error('schemaS3Uri output is not available');
        }
        // s3://{bucketName}/{fileName}
        const uriParts = schemaS3Uri.split('/');
        const bucketName = uriParts[2];
        const objectPath = uriParts.slice(3, uriParts.length).join('/');
        if (!bucketName || !objectPath) {
            throw new Error('schemaS3Uri is not valid');
        }
        const s3Response = await this.s3Client.send(new GetObjectCommand({ Bucket: bucketName, Key: objectPath }));
        if (!s3Response.Body) {
            throw new Error(`s3Response from ${schemaS3Uri} does not contain a Body`);
        }
        return await s3Response.Body?.transformToString();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95ZWRfYmFja2VuZF9jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGVwbG95ZWRfYmFja2VuZF9jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBY0EsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDMUUsT0FBTyxFQUdMLDRCQUE0QixHQUM3QixNQUFNLG9DQUFvQyxDQUFDO0FBQzVDLE9BQU8sRUFFTCxrQkFBa0IsRUFDbEIscUJBQXFCLEVBQ3JCLHlCQUF5QixFQUN6QixpQkFBaUIsRUFJakIsV0FBVyxHQUVaLE1BQU0sZ0NBQWdDLENBQUM7QUFFeEMsT0FBTyxFQUFFLGdCQUFnQixFQUFZLE1BQU0sb0JBQW9CLENBQUM7QUFDaEUsT0FBTyxFQUNMLGFBQWEsRUFDYixnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBQ2pCLGdCQUFnQixHQUNqQixNQUFNLHFDQUFxQyxDQUFDO0FBSzdDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDRCQUE0QjtJQUtwQjtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFUbkI7O09BRUc7SUFDSCxZQUNtQixTQUErQixFQUMvQixRQUFrQixFQUNsQixtQkFBd0MsRUFDeEMsMkJBQXdELEVBQ3hELGlCQUFvQyxFQUNwQyxTQUFvQjtRQUxwQixjQUFTLEdBQVQsU0FBUyxDQUFzQjtRQUMvQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsZ0NBQTJCLEdBQTNCLDJCQUEyQixDQUE2QjtRQUN4RCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLGNBQVMsR0FBVCxTQUFTLENBQVc7SUFDcEMsQ0FBQztJQUVKOztPQUVHO0lBQ0gsYUFBYSxHQUFHLEtBQUssRUFDbkIsd0JBQXlELEVBQzFDLEVBQUU7UUFDakIsTUFBTSxTQUFTLEdBQUcsNEJBQTRCLENBQUMsV0FBVyxDQUFDO1lBQ3pELEdBQUcs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aWZpZXIsXG4gIEJhY2tlbmRPdXRwdXQsXG4gIERlcGxveW1lbnRUeXBlLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIEFwaUF1dGhUeXBlLFxuICBCYWNrZW5kTWV0YWRhdGEsXG4gIENvbmZsaWN0UmVzb2x1dGlvbk1vZGUsXG4gIERlcGxveWVkQmFja2VuZENsaWVudCxcbiAgTGlzdFNhbmRib3hlc1JlcXVlc3QsXG4gIExpc3RTYW5kYm94ZXNSZXNwb25zZSxcbiAgU2FuZGJveE1ldGFkYXRhLFxufSBmcm9tICcuL2RlcGxveWVkX2JhY2tlbmRfY2xpZW50X2ZhY3RvcnkuanMnO1xuaW1wb3J0IHsgQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucyB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXRDbGllbnQsXG4gIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcixcbiAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZSxcbn0gZnJvbSAnLi9iYWNrZW5kX291dHB1dF9jbGllbnRfZmFjdG9yeS5qcyc7XG5pbXBvcnQge1xuICBDbG91ZEZvcm1hdGlvbkNsaWVudCxcbiAgRGVsZXRlU3RhY2tDb21tYW5kLFxuICBEZXNjcmliZVN0YWNrc0NvbW1hbmQsXG4gIExpc3RTdGFja1Jlc291cmNlc0NvbW1hbmQsXG4gIExpc3RTdGFja3NDb21tYW5kLFxuICBMaXN0U3RhY2tzQ29tbWFuZE91dHB1dCxcbiAgU3RhY2ssXG4gIFN0YWNrUmVzb3VyY2VTdW1tYXJ5LFxuICBTdGFja1N0YXR1cyxcbiAgU3RhY2tTdW1tYXJ5LFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtY2xvdWRmb3JtYXRpb24nO1xuXG5pbXBvcnQgeyBHZXRPYmplY3RDb21tYW5kLCBTM0NsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQge1xuICBhdXRoT3V0cHV0S2V5LFxuICBncmFwaHFsT3V0cHV0S2V5LFxuICBwbGF0Zm9ybU91dHB1dEtleSxcbiAgc3RvcmFnZU91dHB1dEtleSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgRGVwbG95ZWRSZXNvdXJjZXNFbnVtZXJhdG9yIH0gZnJvbSAnLi9kZXBsb3llZC1iYWNrZW5kLWNsaWVudC9kZXBsb3llZF9yZXNvdXJjZXNfZW51bWVyYXRvci5qcyc7XG5pbXBvcnQgeyBTdGFja1N0YXR1c01hcHBlciB9IGZyb20gJy4vZGVwbG95ZWQtYmFja2VuZC1jbGllbnQvc3RhY2tfc3RhdHVzX21hcHBlci5qcyc7XG5pbXBvcnQgeyBBcm5QYXJzZXIgfSBmcm9tICcuL2RlcGxveWVkLWJhY2tlbmQtY2xpZW50L2Fybl9wYXJzZXIuanMnO1xuXG4vKipcbiAqIERlcGxveW1lbnQgQ2xpZW50XG4gKi9cbmV4cG9ydCBjbGFzcyBEZWZhdWx0RGVwbG95ZWRCYWNrZW5kQ2xpZW50IGltcGxlbWVudHMgRGVwbG95ZWRCYWNrZW5kQ2xpZW50IHtcbiAgLyoqXG4gICAqIENvbnN0cnVjdG9yIGZvciBkZXBsb3ltZW50IGNsaWVudFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBjZm5DbGllbnQ6IENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgczNDbGllbnQ6IFMzQ2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2VuZE91dHB1dENsaWVudDogQmFja2VuZE91dHB1dENsaWVudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRlcGxveWVkUmVzb3VyY2VzRW51bWVyYXRvcjogRGVwbG95ZWRSZXNvdXJjZXNFbnVtZXJhdG9yLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3RhY2tTdGF0dXNNYXBwZXI6IFN0YWNrU3RhdHVzTWFwcGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXJuUGFyc2VyOiBBcm5QYXJzZXJcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBEZWxldGVzIGEgc2FuZGJveCB3aXRoIHRoZSBzcGVjaWZpZWQgaWRcbiAgICovXG4gIGRlbGV0ZVNhbmRib3ggPSBhc3luYyAoXG4gICAgc2FuZGJveEJhY2tlbmRJZGVudGlmaWVyOiBPbWl0PEJhY2tlbmRJZGVudGlmaWVyLCAndHlwZSc+XG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IHN0YWNrTmFtZSA9IEJhY2tlbmRJZGVudGlmaWVyQ29udmVyc2lvbnMudG9TdGFja05hbWUoe1xuICAgICAgLi4uc2FuZGJveEJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgdHlwZTogJ3NhbmRib3gnLFxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQobmV3IERlbGV0ZVN0YWNrQ29tbWFuZCh7IFN0YWNrTmFtZTogc3RhY2tOYW1lIH0pKTtcbiAgfTtcbiAgLyoqXG4gICAqIEZldGNoZXMgYWxsIGJhY2tlbmQgbWV0YWRhdGEgZm9yIGEgc3BlY2lmaWVkIGJhY2tlbmRcbiAgICovXG4gIGdldEJhY2tlbmRNZXRhZGF0YSA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWQ6IEJhY2tlbmRJZGVudGlmaWVyXG4gICk6IFByb21pc2U8QmFja2VuZE1ldGFkYXRhPiA9PiB7XG4gICAgY29uc3Qgc3RhY2tOYW1lID0gQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucy50b1N0YWNrTmFtZShiYWNrZW5kSWQpO1xuICAgIHJldHVybiB0aGlzLmJ1aWxkQmFja2VuZE1ldGFkYXRhKHN0YWNrTmFtZSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFJldHVybnMgQW1wbGlmeSBTYW5kYm94ZXMgZm9yIHRoZSBhY2NvdW50IGFuZCByZWdpb24uIFRoZSBudW1iZXIgb2Ygc2FuZGJveGVzIHJldHVybmVkIGNhbiB2YXJ5XG4gICAqL1xuICBsaXN0U2FuZGJveGVzID0gYXN5bmMgKFxuICAgIGxpc3RTYW5kYm94ZXNSZXF1ZXN0PzogTGlzdFNhbmRib3hlc1JlcXVlc3RcbiAgKTogUHJvbWlzZTxMaXN0U2FuZGJveGVzUmVzcG9uc2U+ID0+IHtcbiAgICBjb25zdCBzdGFja01ldGFkYXRhOiBTYW5kYm94TWV0YWRhdGFbXSA9IFtdO1xuICAgIGxldCBuZXh0VG9rZW4gPSBsaXN0U2FuZGJveGVzUmVxdWVzdD8ubmV4dFRva2VuO1xuXG4gICAgZG8ge1xuICAgICAgY29uc3QgbGlzdFN0YWNrc1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5saXN0U3RhY2tzKG5leHRUb2tlbik7XG4gICAgICBjb25zdCBzdGFja01ldGFkYXRhUHJvbWlzZXMgPSBsaXN0U3RhY2tzUmVzcG9uc2Uuc3RhY2tTdW1tYXJpZXNcbiAgICAgICAgLmZpbHRlcigoc3RhY2tTdW1tYXJ5OiBTdGFja1N1bW1hcnkpID0+IHtcbiAgICAgICAgICByZXR1cm4gc3RhY2tTdW1tYXJ5LlN0YWNrU3RhdHVzICE9PSBTdGFja1N0YXR1cy5ERUxFVEVfQ09NUExFVEU7XG4gICAgICAgIH0pXG4gICAgICAgIC5maWx0ZXIoKHN0YWNrU3VtbWFyeTogU3RhY2tTdW1tYXJ5KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuaXNTYW5kYm94U3RhY2soc3RhY2tTdW1tYXJ5LlN0YWNrTmFtZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5tYXAoYXN5bmMgKHN0YWNrU3VtbWFyeTogU3RhY2tTdW1tYXJ5KSA9PiB7XG4gICAgICAgICAgY29uc3QgZGVwbG95bWVudFR5cGUgPSBhd2FpdCB0aGlzLnRyeUdldERlcGxveW1lbnRUeXBlKHN0YWNrU3VtbWFyeSk7XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbmFtZTogc3RhY2tTdW1tYXJ5LlN0YWNrTmFtZSBhcyBzdHJpbmcsXG4gICAgICAgICAgICBiYWNrZW5kSWQ6IEJhY2tlbmRJZGVudGlmaWVyQ29udmVyc2lvbnMuZnJvbVN0YWNrTmFtZShcbiAgICAgICAgICAgICAgc3RhY2tTdW1tYXJ5LlN0YWNrTmFtZVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGxhc3RVcGRhdGVkOlxuICAgICAgICAgICAgICBzdGFja1N1bW1hcnkuTGFzdFVwZGF0ZWRUaW1lID8/IHN0YWNrU3VtbWFyeS5DcmVhdGlvblRpbWUsXG4gICAgICAgICAgICBzdGF0dXM6IHRoaXMuc3RhY2tTdGF0dXNNYXBwZXIudHJhbnNsYXRlU3RhY2tTdGF0dXMoXG4gICAgICAgICAgICAgIHN0YWNrU3VtbWFyeS5TdGFja1N0YXR1c1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGRlcGxveW1lbnRUeXBlLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuXG4gICAgICBjb25zdCBzdGFja01ldGFkYXRhUmVzb2x2ZWRQcm9taXNlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBzdGFja01ldGFkYXRhUHJvbWlzZXNcbiAgICAgICk7XG4gICAgICBjb25zdCBmaWx0ZXJlZE1ldGFkYXRhID0gc3RhY2tNZXRhZGF0YVJlc29sdmVkUHJvbWlzZXMuZmlsdGVyKFxuICAgICAgICAoc3RhY2tNZXRhZGF0YSkgPT4gc3RhY2tNZXRhZGF0YS5kZXBsb3ltZW50VHlwZSA9PT0gJ3NhbmRib3gnXG4gICAgICApO1xuXG4gICAgICBzdGFja01ldGFkYXRhLnB1c2goLi4uZmlsdGVyZWRNZXRhZGF0YSk7XG4gICAgICBuZXh0VG9rZW4gPSBsaXN0U3RhY2tzUmVzcG9uc2UubmV4dFRva2VuO1xuICAgIH0gd2hpbGUgKHN0YWNrTWV0YWRhdGEubGVuZ3RoID09PSAwICYmIG5leHRUb2tlbik7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc2FuZGJveGVzOiBzdGFja01ldGFkYXRhLFxuICAgICAgbmV4dFRva2VuLFxuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBpc1NhbmRib3hTdGFjayA9IChzdGFja05hbWU6IHN0cmluZyB8IHVuZGVmaW5lZCk6IGJvb2xlYW4gPT4ge1xuICAgIGNvbnN0IGJhY2tlbmRJZGVudGlmaWVyID1cbiAgICAgIEJhY2tlbmRJZGVudGlmaWVyQ29udmVyc2lvbnMuZnJvbVN0YWNrTmFtZShzdGFja05hbWUpO1xuICAgIHJldHVybiBiYWNrZW5kSWRlbnRpZmllcj8udHlwZSA9PT0gJ3NhbmRib3gnO1xuICB9O1xuXG4gIHByaXZhdGUgdHJ5R2V0RGVwbG95bWVudFR5cGUgPSBhc3luYyAoXG4gICAgc3RhY2tTdW1tYXJ5OiBTdGFja1N1bW1hcnlcbiAgKTogUHJvbWlzZTxEZXBsb3ltZW50VHlwZSB8IHVuZGVmaW5lZD4gPT4ge1xuICAgIGNvbnN0IGJhY2tlbmRJZGVudGlmaWVyID0ge1xuICAgICAgc3RhY2tOYW1lOiBzdGFja1N1bW1hcnkuU3RhY2tOYW1lIGFzIHN0cmluZyxcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGJhY2tlbmRPdXRwdXQ6IEJhY2tlbmRPdXRwdXQgPVxuICAgICAgICBhd2FpdCB0aGlzLmJhY2tlbmRPdXRwdXRDbGllbnQuZ2V0T3V0cHV0KGJhY2tlbmRJZGVudGlmaWVyKTtcblxuICAgICAgcmV0dXJuIGJhY2tlbmRPdXRwdXRbcGxhdGZvcm1PdXRwdXRLZXldLnBheWxvYWRcbiAgICAgICAgLmRlcGxveW1lbnRUeXBlIGFzIERlcGxveW1lbnRUeXBlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIChlcnJvciBhcyBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IpLmNvZGUgPT09XG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTUVUQURBVEFfUkVUUklFVkFMX0VSUk9SXG4gICAgICApIHtcbiAgICAgICAgLy8gSWdub3JlIHN0YWNrcyB3aGVyZSBtZXRhZGF0YSBjYW5ub3QgYmUgcmV0cmlldmVkLiBUaGVzZSBhcmUgbm90IEFtcGxpZnkgc3RhY2tzLCBvciBub3QgY29tcGF0aWJsZSB3aXRoIHRoaXMgbGlicmFyeS5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgbGlzdFN0YWNrcyA9IGFzeW5jIChcbiAgICBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZFxuICApOiBQcm9taXNlPHtcbiAgICBzdGFja1N1bW1hcmllczogU3RhY2tTdW1tYXJ5W107XG4gICAgbmV4dFRva2VuOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIH0+ID0+IHtcbiAgICBjb25zdCBzdGFja3M6IExpc3RTdGFja3NDb21tYW5kT3V0cHV0ID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgIG5ldyBMaXN0U3RhY2tzQ29tbWFuZCh7IE5leHRUb2tlbjogbmV4dFRva2VuIH0pXG4gICAgKTtcbiAgICBuZXh0VG9rZW4gPSBzdGFja3MuTmV4dFRva2VuO1xuICAgIHJldHVybiB7IHN0YWNrU3VtbWFyaWVzOiBzdGFja3MuU3RhY2tTdW1tYXJpZXMgPz8gW10sIG5leHRUb2tlbiB9O1xuICB9O1xuXG4gIHByaXZhdGUgYnVpbGRCYWNrZW5kTWV0YWRhdGEgPSBhc3luYyAoXG4gICAgc3RhY2tOYW1lOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxCYWNrZW5kTWV0YWRhdGE+ID0+IHtcbiAgICBjb25zdCBzdGFja0JhY2tlbmRJZGVudGlmaWVyID0ge1xuICAgICAgc3RhY2tOYW1lLFxuICAgIH07XG5cbiAgICBjb25zdCBiYWNrZW5kT3V0cHV0OiBCYWNrZW5kT3V0cHV0ID1cbiAgICAgIGF3YWl0IHRoaXMuYmFja2VuZE91dHB1dENsaWVudC5nZXRPdXRwdXQoc3RhY2tCYWNrZW5kSWRlbnRpZmllcik7XG4gICAgY29uc3Qgc3RhY2tEZXNjcmlwdGlvbiA9IGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgRGVzY3JpYmVTdGFja3NDb21tYW5kKHsgU3RhY2tOYW1lOiBzdGFja05hbWUgfSlcbiAgICApO1xuICAgIGNvbnN0IHN0YWNrID0gc3RhY2tEZXNjcmlwdGlvbj8uU3RhY2tzPy5bMF07XG4gICAgY29uc3Qgc3RhdHVzID0gdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgIHN0YWNrPy5TdGFja1N0YXR1c1xuICAgICk7XG4gICAgY29uc3QgbGFzdFVwZGF0ZWQgPSBzdGFjaz8uTGFzdFVwZGF0ZWRUaW1lID8/IHN0YWNrPy5DcmVhdGlvblRpbWU7XG5cbiAgICBjb25zdCBzdGFja1Jlc291cmNlcyA9IGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgTGlzdFN0YWNrUmVzb3VyY2VzQ29tbWFuZCh7XG4gICAgICAgIFN0YWNrTmFtZTogc3RhY2tOYW1lLFxuICAgICAgfSlcbiAgICApO1xuICAgIGNvbnN0IGNoaWxkU3RhY2tQcm9taXNlczogUHJvbWlzZTxTdGFjayB8IHVuZGVmaW5lZD5bXSA9XG4gICAgICBzdGFja1Jlc291cmNlcy5TdGFja1Jlc291cmNlU3VtbWFyaWVzPy5maWx0ZXIoXG4gICAgICAgIChzdGFja1Jlc291cmNlU3VtbWFyeTogU3RhY2tSZXNvdXJjZVN1bW1hcnkpID0+IHtcbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgc3RhY2tSZXNvdXJjZVN1bW1hcnkuUmVzb3VyY2VUeXBlID09PSAnQVdTOjpDbG91ZEZvcm1hdGlvbjo6U3RhY2snXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgKS5tYXAoYXN5bmMgKHN0YWNrUmVzb3VyY2VTdW1tYXJ5OiBTdGFja1Jlc291cmNlU3VtbWFyeSkgPT4ge1xuICAgICAgICAvLyBhcm46YXdzOntzZXJ2aWNlfTp7cmVnaW9ufTp7YWNjb3VudH06c3RhY2sve3N0YWNrTmFtZX0ve2FkZGl0aW9uYWxGaWVsZHN9XG4gICAgICAgIGNvbnN0IGFyblBhcnRzID0gc3RhY2tSZXNvdXJjZVN1bW1hcnkuUGh5c2ljYWxSZXNvdXJjZUlkPy5zcGxpdCgnLycpO1xuICAgICAgICBjb25zdCBjaGlsZFN0YWNrTmFtZSA9IGFyblBhcnRzPy5bMV07XG4gICAgICAgIGlmICghY2hpbGRTdGFja05hbWUpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3RhY2tEZXNjcmlwdGlvbiA9IGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQoXG4gICAgICAgICAgbmV3IERlc2NyaWJlU3RhY2tzQ29tbWFuZCh7IFN0YWNrTmFtZTogY2hpbGRTdGFja05hbWUgfSlcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBzdGFjayA9IHN0YWNrRGVzY3JpcHRpb24/LlN0YWNrcz8uWzBdO1xuICAgICAgICByZXR1cm4gc3RhY2s7XG4gICAgICB9KSA/PyBbXTtcblxuICAgIGNvbnN0IGNoaWxkU3RhY2tzID0gYXdhaXQgUHJvbWlzZS5hbGwoY2hpbGRTdGFja1Byb21pc2VzKTtcbiAgICBjb25zdCBhdXRoU3RhY2sgPSBjaGlsZFN0YWNrcy5maW5kKFxuICAgICAgKG5lc3RlZFN0YWNrOiBTdGFja1N1bW1hcnkgfCB1bmRlZmluZWQpID0+XG4gICAgICAgIG5lc3RlZFN0YWNrPy5TdGFja05hbWU/LmluY2x1ZGVzKCdhdXRoJylcbiAgICApO1xuICAgIGNvbnN0IHN0b3JhZ2VTdGFjayA9IGNoaWxkU3RhY2tzLmZpbmQoXG4gICAgICAobmVzdGVkU3RhY2s6IFN0YWNrU3VtbWFyeSB8IHVuZGVmaW5lZCkgPT5cbiAgICAgICAgbmVzdGVkU3RhY2s/LlN0YWNrTmFtZT8uaW5jbHVkZXMoJ3N0b3JhZ2UnKVxuICAgICk7XG4gICAgY29uc3QgYXBpU3RhY2sgPSBjaGlsZFN0YWNrcy5maW5kKChuZXN0ZWRTdGFjazogU3RhY2tTdW1tYXJ5IHwgdW5kZWZpbmVkKSA9PlxuICAgICAgbmVzdGVkU3RhY2s/LlN0YWNrTmFtZT8uaW5jbHVkZXMoJ2RhdGEnKVxuICAgICk7XG5cbiAgICAvLyBzdGFjaz8uU3RhY2tJZCBpcyB0aGUgQVJOIG9mIHRoZSBzdGFja1xuICAgIGNvbnN0IHsgYWNjb3VudElkLCByZWdpb24gfSA9IHRoaXMuYXJuUGFyc2VyLnRyeVBhcnNlQXJuKFxuICAgICAgc3RhY2s/LlN0YWNrSWQgYXMgc3RyaW5nXG4gICAgKTtcbiAgICBjb25zdCBiYWNrZW5kTWV0YWRhdGFPYmplY3Q6IEJhY2tlbmRNZXRhZGF0YSA9IHtcbiAgICAgIGRlcGxveW1lbnRUeXBlOiBiYWNrZW5kT3V0cHV0W3BsYXRmb3JtT3V0cHV0S2V5XS5wYXlsb2FkXG4gICAgICAgIC5kZXBsb3ltZW50VHlwZSBhcyBEZXBsb3ltZW50VHlwZSxcbiAgICAgIGxhc3RVcGRhdGVkLFxuICAgICAgc3RhdHVzLFxuICAgICAgbmFtZTogc3RhY2tOYW1lLFxuICAgICAgcmVzb3VyY2VzOiBhd2FpdCB0aGlzLmRlcGxveWVkUmVzb3VyY2VzRW51bWVyYXRvci5saXN0RGVwbG95ZWRSZXNvdXJjZXMoXG4gICAgICAgIHRoaXMuY2ZuQ2xpZW50LFxuICAgICAgICBzdGFja05hbWUsXG4gICAgICAgIGFjY291bnRJZCxcbiAgICAgICAgcmVnaW9uXG4gICAgICApLFxuICAgIH07XG5cbiAgICBpZiAoYXV0aFN0YWNrKSB7XG4gICAgICBiYWNrZW5kTWV0YWRhdGFPYmplY3QuYXV0aENvbmZpZ3VyYXRpb24gPSB7XG4gICAgICAgIHN0YXR1czogdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgICAgICBhdXRoU3RhY2suU3RhY2tTdGF0dXNcbiAgICAgICAgKSxcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IGF1dGhTdGFjay5MYXN0VXBkYXRlZFRpbWUgPz8gYXV0aFN0YWNrLkNyZWF0aW9uVGltZSxcbiAgICAgICAgdXNlclBvb2xJZDogYmFja2VuZE91dHB1dFthdXRoT3V0cHV0S2V5XT8ucGF5bG9hZC51c2VyUG9vbElkIGFzIHN0cmluZyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKHN0b3JhZ2VTdGFjaykge1xuICAgICAgYmFja2VuZE1ldGFkYXRhT2JqZWN0LnN0b3JhZ2VDb25maWd1cmF0aW9uID0ge1xuICAgICAgICBzdGF0dXM6IHRoaXMuc3RhY2tTdGF0dXNNYXBwZXIudHJhbnNsYXRlU3RhY2tTdGF0dXMoXG4gICAgICAgICAgc3RvcmFnZVN0YWNrLlN0YWNrU3RhdHVzXG4gICAgICAgICksXG4gICAgICAgIGxhc3RVcGRhdGVkOiBzdG9yYWdlU3RhY2suTGFzdFVwZGF0ZWRUaW1lID8/IHN0b3JhZ2VTdGFjay5DcmVhdGlvblRpbWUsXG4gICAgICAgIHMzQnVja2V0TmFtZTogYmFja2VuZE91dHB1dFtzdG9yYWdlT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5idWNrZXROYW1lIGFzIHN0cmluZyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKGFwaVN0YWNrKSB7XG4gICAgICBjb25zdCBhZGRpdGlvbmFsQXV0aFR5cGVzU3RyaW5nID1cbiAgICAgICAgYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5hd3NBcHBzeW5jQWRkaXRpb25hbEF1dGhlbnRpY2F0aW9uVHlwZXM7XG4gICAgICBjb25zdCBhZGRpdGlvbmFsQXV0aFR5cGVzID0gYWRkaXRpb25hbEF1dGhUeXBlc1N0cmluZ1xuICAgICAgICA/IChhZGRpdGlvbmFsQXV0aFR5cGVzU3RyaW5nLnNwbGl0KCcsJykgYXMgQXBpQXV0aFR5cGVbXSlcbiAgICAgICAgOiBbXTtcbiAgICAgIGJhY2tlbmRNZXRhZGF0YU9iamVjdC5hcGlDb25maWd1cmF0aW9uID0ge1xuICAgICAgICBzdGF0dXM6IHRoaXMuc3RhY2tTdGF0dXNNYXBwZXIudHJhbnNsYXRlU3RhY2tTdGF0dXMoXG4gICAgICAgICAgYXBpU3RhY2suU3RhY2tTdGF0dXNcbiAgICAgICAgKSxcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IGFwaVN0YWNrLkxhc3RVcGRhdGVkVGltZSA/PyBhcGlTdGFjay5DcmVhdGlvblRpbWUsXG4gICAgICAgIGdyYXBocWxFbmRwb2ludDogYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5hd3NBcHBzeW5jQXBpRW5kcG9pbnQgYXMgc3RyaW5nLFxuICAgICAgICBkZWZhdWx0QXV0aFR5cGU6IGJhY2tlbmRPdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0/LnBheWxvYWRcbiAgICAgICAgICAuYXdzQXBwc3luY0F1dGhlbnRpY2F0aW9uVHlwZSBhcyBBcGlBdXRoVHlwZSxcbiAgICAgICAgYWRkaXRpb25hbEF1dGhUeXBlcyxcbiAgICAgICAgY29uZmxpY3RSZXNvbHV0aW9uTW9kZTogYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5hd3NBcHBzeW5jQ29uZmxpY3RSZXNvbHV0aW9uTW9kZSBhcyBDb25mbGljdFJlc29sdXRpb25Nb2RlLFxuICAgICAgICBhcGlJZDogYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5hd3NBcHBzeW5jQXBpSWQgYXMgc3RyaW5nLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gYmFja2VuZE1ldGFkYXRhT2JqZWN0O1xuICB9O1xuXG4gIHByaXZhdGUgZmV0Y2hTY2hlbWEgPSBhc3luYyAoXG4gICAgc2NoZW1hUzNVcmk6IHN0cmluZyB8IHVuZGVmaW5lZFxuICApOiBQcm9taXNlPHN0cmluZz4gPT4ge1xuICAgIGlmICghc2NoZW1hUzNVcmkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc2NoZW1hUzNVcmkgb3V0cHV0IGlzIG5vdCBhdmFpbGFibGUnKTtcbiAgICB9XG5cbiAgICAvLyBzMzovL3tidWNrZXROYW1lfS97ZmlsZU5hbWV9XG4gICAgY29uc3QgdXJpUGFydHMgPSBzY2hlbWFTM1VyaS5zcGxpdCgnLycpO1xuICAgIGNvbnN0IGJ1Y2tldE5hbWUgPSB1cmlQYXJ0c1syXTtcbiAgICBjb25zdCBvYmplY3RQYXRoID0gdXJpUGFydHMuc2xpY2UoMywgdXJpUGFydHMubGVuZ3RoKS5qb2luKCcvJyk7XG5cbiAgICBpZiAoIWJ1Y2tldE5hbWUgfHwgIW9iamVjdFBhdGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc2NoZW1hUzNVcmkgaXMgbm90IHZhbGlkJyk7XG4gICAgfVxuXG4gICAgY29uc3QgczNSZXNwb25zZSA9IGF3YWl0IHRoaXMuczNDbGllbnQuc2VuZChcbiAgICAgIG5ldyBHZXRPYmplY3RDb21tYW5kKHsgQnVja2V0OiBidWNrZXROYW1lLCBLZXk6IG9iamVjdFBhdGggfSlcbiAgICApO1xuXG4gICAgaWYgKCFzM1Jlc3BvbnNlLkJvZHkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgczNSZXNwb25zZSBmcm9tICR7c2NoZW1hUzNVcml9IGRvZXMgbm90IGNvbnRhaW4gYSBCb2R5YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHMzUmVzcG9uc2UuQm9keT8udHJhbnNmb3JtVG9TdHJpbmcoKTtcbiAgfTtcbn1cbiJdfQ==