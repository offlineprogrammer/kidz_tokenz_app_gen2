import { AmplifyFormRenderer, ModuleKind, ReactIndexStudioTemplateRenderer, ReactUtilsStudioTemplateRenderer, ScriptKind, ScriptTarget, getDeclarationFilename, } from '@aws-amplify/codegen-ui-react';
/**
 * Generates GraphQL-compatible forms in React by directly leveraging @aws-amplify/codegen-ui-react
 */
export class LocalGraphqlFormGenerator {
    schemaFetcher;
    renderOptions;
    resultBuilder;
    static defaultConfig = {
        module: ModuleKind.ES2020,
        target: ScriptTarget.ES2020,
        script: ScriptKind.JSX,
        renderTypeDeclarations: true,
    };
    /**
     * Instantiates a LocalGraphqlFormGenerator for a provided schema
     */
    constructor(schemaFetcher, renderOptions, resultBuilder) {
        this.schemaFetcher = schemaFetcher;
        this.renderOptions = renderOptions;
        this.resultBuilder = resultBuilder;
    }
    /**
     * Gets the react render config
     */
    get config() {
        return {
            module: ModuleKind.ES2020,
            target: ScriptTarget.ES2020,
            script: ScriptKind.JSX,
            includeUseClientDirective: true,
            renderTypeDeclarations: true,
            apiConfiguration: {
                dataApi: 'GraphQL',
                fragmentsFilePath: this.renderGraphqlPath('fragments'),
                mutationsFilePath: this.renderGraphqlPath('mutations'),
                queriesFilePath: this.renderGraphqlPath('queries'),
                subscriptionsFilePath: this.renderGraphqlPath('subscriptions'),
                typesFilePath: this.renderGraphqlPath('types'),
            },
            dependencies: {
                // Tell the renderer to generate amplify js v6 compatible code
                'aws-amplify': '^6.0.0',
            },
        };
    }
    generateIndexFile = (schemas) => {
        const { componentText, fileName } = this.createIndexFile(schemas);
        return {
            schemaName: 'AmplifyStudioIndexFile',
            componentText,
            fileName,
            declaration: undefined,
            error: undefined,
        };
    };
    generateForms = async (options) => {
        const dataSchema = await this.schemaFetcher();
        const filteredModels = this.getFilteredModels(dataSchema, options?.models);
        const filteredSchema = this.transformModelListToMap(filteredModels);
        const utilFile = this.generateUtilFile();
        const baseForms = this.generateBaseForms(filteredSchema);
        const indexFile = this.generateIndexFile(baseForms.map(({ name }) => ({
            name,
        })));
        dataSchema.models = Object.entries(dataSchema.models).reduce((prev, [key, value]) => {
            // Discard createdAt and updatedAt fields
            /* eslint-disable-next-line @typescript-eslint/no-unused-vars */
            const { createdAt, updatedAt, ...fields } = value.fields;
            const valueExcludingTimestampFields = {
                ...value,
                fields,
            };
            prev[key] = valueExcludingTimestampFields;
            return prev;
        }, {});
        const forms = baseForms.reduce((prev, formSchema) => {
            const results = this.codegenForm(dataSchema, formSchema);
            results.forEach((result) => {
                prev[result.fileName] = result.componentText;
            });
            return prev;
        }, {});
        forms[utilFile.fileName] = utilFile.componentText;
        forms[indexFile.fileName] = indexFile.componentText;
        return this.resultBuilder(forms);
    };
    /**
     * reduces the dataSchema to a map of models
     */
    getModelMapForDataSchema = (dataSchema) => {
        return Object.entries(dataSchema.models).reduce((prev, [name, model]) => {
            if (!model.isJoinTable) {
                prev[name] = new Set(['create', 'update']);
            }
            return prev;
        }, {});
    };
    getSchema = (name, type) => ({
        name: `${name}${type === 'create' ? 'CreateForm' : 'UpdateForm'}`,
        formActionType: type,
        dataType: { dataSourceType: 'DataStore', dataTypeName: name },
        fields: {},
        sectionalElements: {},
        style: {},
        cta: {},
    });
    generateBaseForms = (modelMap) => {
        const schemas = [];
        Object.entries(modelMap).forEach(([name, set]) => {
            set.forEach((type) => schemas.push(this.getSchema(name, type)));
        });
        return schemas;
    };
    renderGraphqlPath = (submodule) => {
        const graphqlPath = `${this.renderOptions.graphqlDir}/${submodule}`;
        // if the path does not start with a leading ./ or ../, assume that the graphql folder is in the same directory relative to the ui, and prepend a `./`
        if (graphqlPath.startsWith('.')) {
            return graphqlPath;
        }
        return `./${graphqlPath}`;
    };
    createUiBuilderForm = (schema, dataSchema, formFeatureFlags) => {
        const renderer = new AmplifyFormRenderer(schema, dataSchema, this.config, formFeatureFlags);
        const { componentText, declaration } = renderer.renderComponentInternal();
        const files = [
            {
                componentText,
                fileName: renderer.fileName,
            },
        ];
        if (declaration) {
            files.push({
                componentText: declaration,
                fileName: getDeclarationFilename(renderer.fileName),
            });
        }
        return files;
    };
    filterModelsByName = (filteredModelNames, schemaModel) => {
        const lowerCaseModelKeys = new Set(Object.keys(schemaModel).map((k) => k.toLowerCase()));
        const modelEntries = Object.entries(schemaModel);
        return filteredModelNames.reduce((prev, model) => {
            if (lowerCaseModelKeys?.has(model.toLowerCase())) {
                const entry = modelEntries.find(([key]) => key.toLowerCase() === model.toLowerCase());
                if (!entry) {
                    throw new Error(`Could not find specified model ${model}`);
                }
                prev.push(entry);
                return prev;
            }
            throw new Error(`Could not find specified model ${model}`);
        }, []);
    };
    codegenForm = (dataSchema, formSchema) => {
        return this.createUiBuilderForm(formSchema, dataSchema, {});
    };
    getFilteredModels = (dataSchema, filteredModelNames) => {
        const modelMap = this.getModelMapForDataSchema(dataSchema);
        const filteredModels = [];
        if (!filteredModelNames || !filteredModelNames?.length) {
            filteredModels.push(...Object.entries(modelMap));
        }
        else {
            filteredModels.push(...this.filterModelsByName(filteredModelNames, modelMap));
        }
        return filteredModels;
    };
    transformModelListToMap = (models) => {
        return models.reduce((prev, [key, value]) => ({ ...prev, [key]: value }), {});
    };
    createUtilFile = (utils) => {
        const renderer = new ReactUtilsStudioTemplateRenderer(utils, LocalGraphqlFormGenerator.defaultConfig);
        const { componentText } = renderer.renderComponentInternal();
        return {
            componentText,
            fileName: renderer.fileName,
        };
    };
    /**
     * Return utils file text
     */
    generateUtilFile = () => {
        const utils = [
            'validation',
            'formatter',
            'fetchByPath',
            'processFile',
        ];
        const { componentText, fileName } = this.createUtilFile(utils);
        return {
            schemaName: 'AmplifyStudioUtilFile',
            componentText,
            fileName,
            declaration: undefined,
            error: undefined,
        };
    };
    createIndexFile = (schemas) => {
        const renderer = new ReactIndexStudioTemplateRenderer(schemas, LocalGraphqlFormGenerator.defaultConfig);
        const { componentText } = renderer.renderComponentInternal();
        return {
            componentText,
            fileName: renderer.fileName,
        };
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxfY29kZWdlbl9ncmFwaHFsX2Zvcm1fZ2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xvY2FsX2NvZGVnZW5fZ3JhcGhxbF9mb3JtX2dlbmVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFNQSxPQUFPLEVBQ0wsbUJBQW1CLEVBQ25CLFVBQVUsRUFDVixnQ0FBZ0MsRUFFaEMsZ0NBQWdDLEVBQ2hDLFVBQVUsRUFDVixZQUFZLEVBRVosc0JBQXNCLEdBQ3ZCLE1BQU0sK0JBQStCLENBQUM7QUFzQnZDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHlCQUF5QjtJQVkxQjtJQUNBO0lBQ0E7SUFiRixNQUFNLENBQUMsYUFBYSxHQUFHO1FBQzdCLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtRQUN6QixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07UUFDM0IsTUFBTSxFQUFFLFVBQVUsQ0FBQyxHQUFHO1FBQ3RCLHNCQUFzQixFQUFFLElBQUk7S0FDN0IsQ0FBQztJQUVGOztPQUVHO0lBQ0gsWUFDVSxhQUE0QixFQUM1QixhQUE0QixFQUM1QixhQUE0QjtRQUY1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUNuQyxDQUFDO0lBRUo7O09BRUc7SUFDSCxJQUFZLE1BQU07UUFDaEIsT0FBTztZQUNMLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtZQUN6QixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07WUFDM0IsTUFBTSxFQUFFLFVBQVUsQ0FBQyxHQUFHO1lBQ3RCLHlCQUF5QixFQUFFLElBQUk7WUFDL0Isc0JBQXNCLEVBQUUsSUFBSTtZQUM1QixnQkFBZ0IsRUFBRTtnQkFDaEIsT0FBTyxFQUFFLFNBQVM7Z0JBQ2xCLGlCQUFpQixFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUM7Z0JBQ3RELGlCQUFp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QUVHO0lBQ0ssZ0JBQWdCLEdBQUcsR0FBRyxFQUFFO1FBQzlCLE1BQU0sS0FBSyxHQUF1QjtZQUNoQyxZQUFZO1lBQ1osV0FBVztZQUNYLGFBQWE7WUFDYixhQUFhO1NBQ2QsQ0FBQztRQUNGLE1BQU0sRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvRCxPQUFPO1lBQ0wsVUFBVSxFQUFFLHVCQUF1QjtZQUNuQyxhQUFhO1lBQ2IsUUFBUTtZQUNSLFdBQVcsRUFBRSxTQUFTO1lBQ3RCLEtBQUssRUFBRSxTQUFTO1NBQ2pCLENBQUM7SUFDSixDQUFDLENBQUM7SUFFTSxlQUFlLEdBQUcsQ0FBQyxPQUF1QixFQUFFLEVBQUU7UUFDcEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxnQ0FBZ0MsQ0FDbkQsT0FBTyxFQUNQLHlCQUF5QixDQUFDLGFBQWEsQ0FDeEMsQ0FBQztRQUNGLE1BQU0sRUFBRSxhQUFhLEVBQUUsR0FBRyxRQUFRLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUM3RCxPQUFPO1lBQ0wsYUFBYTtZQUNiLFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUTtTQUM1QixDQUFDO0lBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRm9ybUZlYXR1cmVGbGFncyxcbiAgR2VuZXJpY0RhdGFTY2hlbWEsXG4gIFN0dWRpb0Zvcm0sXG4gIFN0dWRpb1NjaGVtYSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NvZGVnZW4tdWknO1xuaW1wb3J0IHtcbiAgQW1wbGlmeUZvcm1SZW5kZXJlcixcbiAgTW9kdWxlS2luZCxcbiAgUmVhY3RJbmRleFN0dWRpb1RlbXBsYXRlUmVuZGVyZXIsXG4gIFJlYWN0UmVuZGVyQ29uZmlnLFxuICBSZWFjdFV0aWxzU3R1ZGlvVGVtcGxhdGVSZW5kZXJlcixcbiAgU2NyaXB0S2luZCxcbiAgU2NyaXB0VGFyZ2V0LFxuICBVdGlsVGVtcGxhdGVUeXBlLFxuICBnZXREZWNsYXJhdGlvbkZpbGVuYW1lLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvY29kZWdlbi11aS1yZWFjdCc7XG5pbXBvcnQge1xuICBGb3JtR2VuZXJhdGlvbk9wdGlvbnMsXG4gIEdyYXBocWxGb3JtR2VuZXJhdG9yLFxuICBHcmFwaHFsR2VuZXJhdGlvblJlc3VsdCxcbn0gZnJvbSAnLi9ncmFwaHFsX2Zvcm1fZ2VuZXJhdG9yLmpzJztcblxudHlwZSBGb3JtRGVmID0gU2V0PCdjcmVhdGUnIHwgJ3VwZGF0ZSc+O1xudHlwZSBNb2RlbFJlY29yZCA9IFJlY29yZDxzdHJpbmcsIEZvcm1EZWY+O1xuXG4vKipcbiAqIFJlbmRlciBDb25maWd1cmF0aW9uIE9wdGlvbnMgZm9yIHJlYWN0IGZvcm1zXG4gKi9cbmV4cG9ydCB0eXBlIFJlbmRlck9wdGlvbnMgPSB7XG4gIGdyYXBocWxEaXI6IHN0cmluZztcbn07XG5cbmV4cG9ydCB0eXBlIFJlc3VsdEJ1aWxkZXIgPSAoXG4gIGZpbGVNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbikgPT4gR3JhcGhxbEdlbmVyYXRpb25SZXN1bHQ7XG5cbmV4cG9ydCB0eXBlIFNjaGVtYUZldGNoZXIgPSAoKSA9PiBQcm9taXNlPEdlbmVyaWNEYXRhU2NoZW1hPjtcbi8qKlxuICogR2VuZXJhdGVzIEdyYXBoUUwtY29tcGF0aWJsZSBmb3JtcyBpbiBSZWFjdCBieSBkaXJlY3RseSBsZXZlcmFnaW5nIEBhd3MtYW1wbGlmeS9jb2RlZ2VuLXVpLXJlYWN0XG4gKi9cbmV4cG9ydCBjbGFzcyBMb2NhbEdyYXBocWxGb3JtR2VuZXJhdG9yIGltcGxlbWVudHMgR3JhcGhxbEZvcm1HZW5lcmF0b3Ige1xuICBwcml2YXRlIHN0YXRpYyBkZWZhdWx0Q29uZmlnID0ge1xuICAgIG1vZHVsZTogTW9kdWxlS2luZC5FUzIwMjAsXG4gICAgdGFyZ2V0OiBTY3JpcHRUYXJnZXQuRVMyMDIwLFxuICAgIHNjcmlwdDogU2NyaXB0S2luZC5KU1gsXG4gICAgcmVuZGVyVHlwZURlY2xhcmF0aW9uczogdHJ1ZSxcbiAgfTtcblxuICAvKipcbiAgICogSW5zdGFudGlhdGVzIGEgTG9jYWxHcmFwaHFsRm9ybUdlbmVyYXRvciBmb3IgYSBwcm92aWRlZCBzY2hlbWFcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgc2NoZW1hRmV0Y2hlcjogU2NoZW1hRmV0Y2hlcixcbiAgICBwcml2YXRlIHJlbmRlck9wdGlvbnM6IFJlbmRlck9wdGlvbnMsXG4gICAgcHJpdmF0ZSByZXN1bHRCdWlsZGVyOiBSZXN1bHRCdWlsZGVyXG4gICkge31cblxuICAvKipcbiAgICogR2V0cyB0aGUgcmVhY3QgcmVuZGVyIGNvbmZpZ1xuICAgKi9cbiAgcHJpdmF0ZSBnZXQgY29uZmlnKCk6IFJlYWN0UmVuZGVyQ29uZmlnIHtcbiAgICByZXR1cm4ge1xuICAgICAgbW9kdWxlOiBNb2R1bGVLaW5kLkVTMjAyMCxcbiAgICAgIHRhcmdldDogU2NyaXB0VGFyZ2V0LkVTMjAyMCxcbiAgICAgIHNjcmlwdDogU2NyaXB0S2luZC5KU1gsXG4gICAgICBpbmNsdWRlVXNlQ2xpZW50RGlyZWN0aXZlOiB0cnVlLFxuICAgICAgcmVuZGVyVHlwZURlY2xhcmF0aW9uczogdHJ1ZSxcbiAgICAgIGFwaUNvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgZGF0YUFwaTogJ0dyYXBoUUwnLFxuICAgICAgICBmcmFnbWVudHNGaWxlUGF0aDogdGhpcy5yZW5kZXJHcmFwaHFsUGF0aCgnZnJhZ21lbnRzJyksXG4gICAgICAgIG11dGF0aW9uc0ZpbGVQYXRoOiB0aGlzLnJlbmRlckdyYXBocWxQYXRoKCdtdXRhdGlvbnMnKSxcbiAgICAgICAgcXVlcmllc0ZpbGVQYXRoOiB0aGlzLnJlbmRlckdyYXBocWxQYXRoKCdxdWVyaWVzJyksXG4gICAgICAgIHN1YnNjcmlwdGlvbnNGaWxlUGF0aDogdGhpcy5yZW5kZXJHcmFwaHFsUGF0aCgnc3Vic2NyaXB0aW9ucycpLFxuICAgICAgICB0eXBlc0ZpbGVQYXRoOiB0aGlzLnJlbmRlckdyYXBocWxQYXRoKCd0eXBlcycpLFxuICAgICAgfSxcbiAgICAgIGRlcGVuZGVuY2llczoge1xuICAgICAgICAvLyBUZWxsIHRoZSByZW5kZXJlciB0byBnZW5lcmF0ZSBhbXBsaWZ5IGpzIHY2IGNvbXBhdGlibGUgY29kZVxuICAgICAgICAnYXdzLWFtcGxpZnknOiAnXjYuMC4wJyxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIGdlbmVyYXRlSW5kZXhGaWxlID0gKHNjaGVtYXM6IHsgbmFtZTogc3RyaW5nIH1bXSkgPT4ge1xuICAgIGNvbnN0IHsgY29tcG9uZW50VGV4dCwgZmlsZU5hbWUgfSA9IHRoaXMuY3JlYXRlSW5kZXhGaWxlKFxuICAgICAgc2NoZW1hcyBhcyBTdHVkaW9TY2hlbWFbXVxuICAgICk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNjaGVtYU5hbWU6ICdBbXBsaWZ5U3R1ZGlvSW5kZXhGaWxlJyxcbiAgICAgIGNvbXBvbmVudFRleHQsXG4gICAgICBmaWxlTmFtZSxcbiAgICAgIGRlY2xhcmF0aW9uOiB1bmRlZmluZWQsXG4gICAgICBlcnJvcjogdW5kZWZpbmVkLFxuICAgIH07XG4gIH07XG5cbiAgZ2VuZXJhdGVGb3JtcyA9IGFzeW5jIChcbiAgICBvcHRpb25zPzogRm9ybUdlbmVyYXRpb25PcHRpb25zXG4gICk6IFByb21pc2U8R3JhcGhxbEdlbmVyYXRpb25SZXN1bHQ+ID0+IHtcbiAgICBjb25zdCBkYXRhU2NoZW1hID0gYXdhaXQgdGhpcy5zY2hlbWFGZXRjaGVyKCk7XG4gICAgY29uc3QgZmlsdGVyZWRNb2RlbHMgPSB0aGlzLmdldEZpbHRlcmVkTW9kZWxzKGRhdGFTY2hlbWEsIG9wdGlvbnM/Lm1vZGVscyk7XG4gICAgY29uc3QgZmlsdGVyZWRTY2hlbWEgPSB0aGlzLnRyYW5zZm9ybU1vZGVsTGlzdFRvTWFwKGZpbHRlcmVkTW9kZWxzKTtcbiAgICBjb25zdCB1dGlsRmlsZSA9IHRoaXMuZ2VuZXJhdGVVdGlsRmlsZSgpO1xuICAgIGNvbnN0IGJhc2VGb3JtcyA9IHRoaXMuZ2VuZXJhdGVCYXNlRm9ybXMoZmlsdGVyZWRTY2hlbWEpO1xuICAgIGNvbnN0IGluZGV4RmlsZSA9IHRoaXMuZ2VuZXJhdGVJbmRleEZpbGUoXG4gICAgICBiYXNlRm9ybXMubWFwKCh7IG5hbWUgfSkgPT4gKHtcbiAgICAgICAgbmFtZSxcbiAgICAgIH0pKVxuICAgICk7XG5cbiAgICBkYXRhU2NoZW1hLm1vZGVscyA9IE9iamVjdC5lbnRyaWVzKGRhdGFTY2hlbWEubW9kZWxzKS5yZWR1Y2U8XG4gICAgICAodHlwZW9mIGRhdGFTY2hlbWEpWydtb2RlbHMnXVxuICAgID4oKHByZXYsIFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgLy8gRGlzY2FyZCBjcmVhdGVkQXQgYW5kIHVwZGF0ZWRBdCBmaWVsZHNcbiAgICAgIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnMgKi9cbiAgICAgIGNvbnN0IHsgY3JlYXRlZEF0LCB1cGRhdGVkQXQsIC4uLmZpZWxkcyB9ID0gdmFsdWUuZmllbGRzO1xuXG4gICAgICBjb25zdCB2YWx1ZUV4Y2x1ZGluZ1RpbWVzdGFtcEZpZWxkcyA9IHtcbiAgICAgICAgLi4udmFsdWUsXG4gICAgICAgIGZpZWxkcyxcbiAgICAgIH07XG5cbiAgICAgIHByZXZba2V5XSA9IHZhbHVlRXhjbHVkaW5nVGltZXN0YW1wRmllbGRzO1xuXG4gICAgICByZXR1cm4gcHJldjtcbiAgICB9LCB7fSk7XG5cbiAgICBjb25zdCBmb3JtcyA9IGJhc2VGb3Jtcy5yZWR1Y2U8UmVjb3JkPHN0cmluZywgc3RyaW5nPj4oXG4gICAgICAocHJldiwgZm9ybVNjaGVtYSkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHRzID0gdGhpcy5jb2RlZ2VuRm9ybShkYXRhU2NoZW1hLCBmb3JtU2NoZW1hKTtcbiAgICAgICAgcmVzdWx0cy5mb3JFYWNoKChyZXN1bHQpID0+IHtcbiAgICAgICAgICBwcmV2W3Jlc3VsdC5maWxlTmFtZV0gPSByZXN1bHQuY29tcG9uZW50VGV4dDtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBwcmV2O1xuICAgICAgfSxcbiAgICAgIHt9XG4gICAgKTtcbiAgICBmb3Jtc1t1dGlsRmlsZS5maWxlTmFtZV0gPSB1dGlsRmlsZS5jb21wb25lbnRUZXh0O1xuICAgIGZvcm1zW2luZGV4RmlsZS5maWxlTmFtZV0gPSBpbmRleEZpbGUuY29tcG9uZW50VGV4dDtcbiAgICByZXR1cm4gdGhpcy5yZXN1bHRCdWlsZGVyKGZvcm1zKTtcbiAgfTtcblxuICAvKipcbiAgICogcmVkdWNlcyB0aGUgZGF0YVNjaGVtYSB0byBhIG1hcCBvZiBtb2RlbHNcbiAgICovXG4gIHByaXZhdGUgZ2V0TW9kZWxNYXBGb3JEYXRhU2NoZW1hID0gKGRhdGFTY2hlbWE6IEdlbmVyaWNEYXRhU2NoZW1hKSA9PiB7XG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKGRhdGFTY2hlbWEubW9kZWxzKS5yZWR1Y2U8TW9kZWxSZWNvcmQ+KFxuICAgICAgKHByZXYsIFtuYW1lLCBtb2RlbF0pID0+IHtcbiAgICAgICAgaWYgKCFtb2RlbC5pc0pvaW5UYWJsZSkge1xuICAgICAgICAgIHByZXZbbmFtZV0gPSBuZXcgU2V0KFsnY3JlYXRlJywgJ3VwZGF0ZSddKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcHJldjtcbiAgICAgIH0sXG4gICAgICB7fVxuICAgICk7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRTY2hlbWEgPSAoXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHR5cGU6ICdjcmVhdGUnIHwgJ3VwZGF0ZSdcbiAgKTogU3R1ZGlvRm9ybSA9PiAoe1xuICAgIG5hbWU6IGAke25hbWV9JHt0eXBlID09PSAnY3JlYXRlJyA/ICdDcmVhdGVGb3JtJyA6ICdVcGRhdGVGb3JtJ31gLFxuICAgIGZvcm1BY3Rpb25UeXBlOiB0eXBlLFxuICAgIGRhdGFUeXBlOiB7IGRhdGFTb3VyY2VUeXBlOiAnRGF0YVN0b3JlJywgZGF0YVR5cGVOYW1lOiBuYW1lIH0sXG4gICAgZmllbGRzOiB7fSxcbiAgICBzZWN0aW9uYWxFbGVtZW50czoge30sXG4gICAgc3R5bGU6IHt9LFxuICAgIGN0YToge30sXG4gIH0pO1xuXG4gIHByaXZhdGUgZ2VuZXJhdGVCYXNlRm9ybXMgPSAobW9kZWxNYXA6IHtcbiAgICBbbW9kZWw6IHN0cmluZ106IFNldDwnY3JlYXRlJyB8ICd1cGRhdGUnPjtcbiAgfSk6IFN0dWRpb0Zvcm1bXSA9PiB7XG4gICAgY29uc3Qgc2NoZW1hczogU3R1ZGlvRm9ybVtdID0gW107XG4gICAgT2JqZWN0LmVudHJpZXMobW9kZWxNYXApLmZvckVhY2goKFtuYW1lLCBzZXRdKSA9PiB7XG4gICAgICBzZXQuZm9yRWFjaCgodHlwZSkgPT4gc2NoZW1hcy5wdXNoKHRoaXMuZ2V0U2NoZW1hKG5hbWUsIHR5cGUpKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHNjaGVtYXM7XG4gIH07XG5cbiAgcHJpdmF0ZSByZW5kZXJHcmFwaHFsUGF0aCA9IChcbiAgICBzdWJtb2R1bGU6ICdmcmFnbWVudHMnIHwgJ211dGF0aW9ucycgfCAncXVlcmllcycgfCAndHlwZXMnIHwgJ3N1YnNjcmlwdGlvbnMnXG4gICkgPT4ge1xuICAgIGNvbnN0IGdyYXBocWxQYXRoID0gYCR7dGhpcy5yZW5kZXJPcHRpb25zLmdyYXBocWxEaXJ9LyR7c3VibW9kdWxlfWA7XG4gICAgLy8gaWYgdGhlIHBhdGggZG9lcyBub3Qgc3RhcnQgd2l0aCBhIGxlYWRpbmcgLi8gb3IgLi4vLCBhc3N1bWUgdGhhdCB0aGUgZ3JhcGhxbCBmb2xkZXIgaXMgaW4gdGhlIHNhbWUgZGlyZWN0b3J5IHJlbGF0aXZlIHRvIHRoZSB1aSwgYW5kIHByZXBlbmQgYSBgLi9gXG4gICAgaWYgKGdyYXBocWxQYXRoLnN0YXJ0c1dpdGgoJy4nKSkge1xuICAgICAgcmV0dXJuIGdyYXBocWxQYXRoO1xuICAgIH1cbiAgICByZXR1cm4gYC4vJHtncmFwaHFsUGF0aH1gO1xuICB9O1xuXG4gIHByaXZhdGUgY3JlYXRlVWlCdWlsZGVyRm9ybSA9IChcbiAgICBzY2hlbWE6IFN0dWRpb0Zvcm0sXG4gICAgZGF0YVNjaGVtYT86IEdlbmVyaWNEYXRhU2NoZW1hLFxuICAgIGZvcm1GZWF0dXJlRmxhZ3M/OiBGb3JtRmVhdHVyZUZsYWdzXG4gICkgPT4ge1xuICAgIGNvbnN0IHJlbmRlcmVyID0gbmV3IEFtcGxpZnlGb3JtUmVuZGVyZXIoXG4gICAgICBzY2hlbWEsXG4gICAgICBkYXRhU2NoZW1hLFxuICAgICAgdGhpcy5jb25maWcsXG4gICAgICBmb3JtRmVhdHVyZUZsYWdzXG4gICAgKTtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQsIGRlY2xhcmF0aW9uIH0gPSByZW5kZXJlci5yZW5kZXJDb21wb25lbnRJbnRlcm5hbCgpO1xuICAgIGNvbnN0IGZpbGVzID0gW1xuICAgICAge1xuICAgICAgICBjb21wb25lbnRUZXh0LFxuICAgICAgICBmaWxlTmFtZTogcmVuZGVyZXIuZmlsZU5hbWUsXG4gICAgICB9LFxuICAgIF07XG4gICAgaWYgKGRlY2xhcmF0aW9uKSB7XG4gICAgICBmaWxlcy5wdXNoKHtcbiAgICAgICAgY29tcG9uZW50VGV4dDogZGVjbGFyYXRpb24sXG4gICAgICAgIGZpbGVOYW1lOiBnZXREZWNsYXJhdGlvbkZpbGVuYW1lKHJlbmRlcmVyLmZpbGVOYW1lKSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBmaWxlcztcbiAgfTtcbiAgcHJpdmF0ZSBmaWx0ZXJNb2RlbHNCeU5hbWUgPSAoXG4gICAgZmlsdGVyZWRNb2RlbE5hbWVzOiBzdHJpbmdbXSxcbiAgICBzY2hlbWFNb2RlbDogTW9kZWxSZWNvcmRcbiAgKSA9PiB7XG4gICAgY29uc3QgbG93ZXJDYXNlTW9kZWxLZXlzID0gbmV3IFNldChcbiAgICAgIE9iamVjdC5rZXlzKHNjaGVtYU1vZGVsKS5tYXAoKGspID0+IGsudG9Mb3dlckNhc2UoKSlcbiAgICApO1xuICAgIGNvbnN0IG1vZGVsRW50cmllcyA9IE9iamVjdC5lbnRyaWVzKHNjaGVtYU1vZGVsKTtcbiAgICByZXR1cm4gZmlsdGVyZWRNb2RlbE5hbWVzLnJlZHVjZTxBcnJheTxbc3RyaW5nLCBGb3JtRGVmXT4+KFxuICAgICAgKHByZXYsIG1vZGVsKSA9PiB7XG4gICAgICAgIGlmIChsb3dlckNhc2VNb2RlbEtleXM/Lmhhcyhtb2RlbC50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgICAgIGNvbnN0IGVudHJ5ID0gbW9kZWxFbnRyaWVzLmZpbmQoXG4gICAgICAgICAgICAoW2tleV0pID0+IGtleS50b0xvd2VyQ2FzZSgpID09PSBtb2RlbC50b0xvd2VyQ2FzZSgpXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAoIWVudHJ5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIHNwZWNpZmllZCBtb2RlbCAke21vZGVsfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBwcmV2LnB1c2goZW50cnkpO1xuICAgICAgICAgIHJldHVybiBwcmV2O1xuICAgICAgICB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgc3BlY2lmaWVkIG1vZGVsICR7bW9kZWx9YCk7XG4gICAgICB9LFxuICAgICAgW11cbiAgICApO1xuICB9O1xuICBwcml2YXRlIGNvZGVnZW5Gb3JtID0gKFxuICAgIGRhdGFTY2hlbWE6IEdlbmVyaWNEYXRhU2NoZW1hLFxuICAgIGZvcm1TY2hlbWE6IFN0dWRpb0Zvcm1cbiAgKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlVWlCdWlsZGVyRm9ybShmb3JtU2NoZW1hLCBkYXRhU2NoZW1hLCB7fSk7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRGaWx0ZXJlZE1vZGVscyA9IChcbiAgICBkYXRhU2NoZW1hOiBHZW5lcmljRGF0YVNjaGVtYSxcbiAgICBmaWx0ZXJlZE1vZGVsTmFtZXM/OiBzdHJpbmdbXVxuICApID0+IHtcbiAgICBjb25zdCBtb2RlbE1hcCA9IHRoaXMuZ2V0TW9kZWxNYXBGb3JEYXRhU2NoZW1hKGRhdGFTY2hlbWEpO1xuICAgIGNvbnN0IGZpbHRlcmVkTW9kZWxzOiBBcnJheTxbc3RyaW5nLCBGb3JtRGVmXT4gPSBbXTtcbiAgICBpZiAoIWZpbHRlcmVkTW9kZWxOYW1lcyB8fCAhZmlsdGVyZWRNb2RlbE5hbWVzPy5sZW5ndGgpIHtcbiAgICAgIGZpbHRlcmVkTW9kZWxzLnB1c2goLi4uT2JqZWN0LmVudHJpZXMobW9kZWxNYXApKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmlsdGVyZWRNb2RlbHMucHVzaChcbiAgICAgICAgLi4udGhpcy5maWx0ZXJNb2RlbHNCeU5hbWUoZmlsdGVyZWRNb2RlbE5hbWVzLCBtb2RlbE1hcClcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBmaWx0ZXJlZE1vZGVscztcbiAgfTtcbiAgcHJpdmF0ZSB0cmFuc2Zvcm1Nb2RlbExpc3RUb01hcCA9IChtb2RlbHM6IEFycmF5PFtzdHJpbmcsIEZvcm1EZWZdPikgPT4ge1xuICAgIHJldHVybiBtb2RlbHMucmVkdWNlKFxuICAgICAgKHByZXYsIFtrZXksIHZhbHVlXSkgPT4gKHsgLi4ucHJldiwgW2tleV06IHZhbHVlIH0pLFxuICAgICAge31cbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgY3JlYXRlVXRpbEZpbGUgPSAodXRpbHM6IFV0aWxUZW1wbGF0ZVR5cGVbXSkgPT4ge1xuICAgIGNvbnN0IHJlbmRlcmVyID0gbmV3IFJlYWN0VXRpbHNTdHVkaW9UZW1wbGF0ZVJlbmRlcmVyKFxuICAgICAgdXRpbHMsXG4gICAgICBMb2NhbEdyYXBocWxGb3JtR2VuZXJhdG9yLmRlZmF1bHRDb25maWdcbiAgICApO1xuICAgIGNvbnN0IHsgY29tcG9uZW50VGV4dCB9ID0gcmVuZGVyZXIucmVuZGVyQ29tcG9uZW50SW50ZXJuYWwoKTtcbiAgICByZXR1cm4ge1xuICAgICAgY29tcG9uZW50VGV4dCxcbiAgICAgIGZpbGVOYW1lOiByZW5kZXJlci5maWxlTmFtZSxcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZXR1cm4gdXRpbHMgZmlsZSB0ZXh0XG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlVXRpbEZpbGUgPSAoKSA9PiB7XG4gICAgY29uc3QgdXRpbHM6IFV0aWxUZW1wbGF0ZVR5cGVbXSA9IFtcbiAgICAgICd2YWxpZGF0aW9uJyxcbiAgICAgICdmb3JtYXR0ZXInLFxuICAgICAgJ2ZldGNoQnlQYXRoJyxcbiAgICAgICdwcm9jZXNzRmlsZScsXG4gICAgXTtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQsIGZpbGVOYW1lIH0gPSB0aGlzLmNyZWF0ZVV0aWxGaWxlKHV0aWxzKTtcbiAgICByZXR1cm4ge1xuICAgICAgc2NoZW1hTmFtZTogJ0FtcGxpZnlTdHVkaW9VdGlsRmlsZScsXG4gICAgICBjb21wb25lbnRUZXh0LFxuICAgICAgZmlsZU5hbWUsXG4gICAgICBkZWNsYXJhdGlvbjogdW5kZWZpbmVkLFxuICAgICAgZXJyb3I6IHVuZGVmaW5lZCxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgY3JlYXRlSW5kZXhGaWxlID0gKHNjaGVtYXM6IFN0dWRpb1NjaGVtYVtdKSA9PiB7XG4gICAgY29uc3QgcmVuZGVyZXIgPSBuZXcgUmVhY3RJbmRleFN0dWRpb1RlbXBsYXRlUmVuZGVyZXIoXG4gICAgICBzY2hlbWFzLFxuICAgICAgTG9jYWxHcmFwaHFsRm9ybUdlbmVyYXRvci5kZWZhdWx0Q29uZmlnXG4gICAgKTtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQgfSA9IHJlbmRlcmVyLnJlbmRlckNvbXBvbmVudEludGVybmFsKCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbXBvbmVudFRleHQsXG4gICAgICBmaWxlTmFtZTogcmVuZGVyZXIuZmlsZU5hbWUsXG4gICAgfTtcbiAgfTtcbn1cbiJdfQ==