/**
 * Converts client config to a different shapes.
 */
export class ClientConfigConverter {
    packageName;
    packageVersion;
    /**
     * Creates client config converter
     */
    constructor(packageName, packageVersion) {
        this.packageName = packageName;
        this.packageVersion = packageVersion;
    }
    /**
     * Converts client config to a shape consumable by mobile libraries.
     */
    convertToMobileConfig = (clientConfig) => {
        const userAgent = `${this.packageName}/${this.packageVersion}`;
        const mobileConfig = {
            UserAgent: userAgent,
            Version: '1.0',
        };
        if (clientConfig.aws_user_pools_id) {
            const authConfig = {
                plugins: {
                    awsCognitoAuthPlugin: {
                        UserAgent: userAgent,
                        Version: '1.0',
                        CognitoUserPool: {
                            Default: {
                                PoolId: clientConfig.aws_user_pools_id,
                                AppClientId: clientConfig.aws_user_pools_web_client_id,
                                Region: clientConfig.aws_cognito_region,
                            },
                        },
                        CredentialsProvider: {
                            CognitoIdentity: {
                                Default: {
                                    PoolId: clientConfig.aws_cognito_identity_pool_id,
                                    Region: clientConfig.aws_cognito_region,
                                },
                            },
                        },
                        Auth: {
                            Default: {
                                authenticationFlowType: 'USER_SRP_AUTH',
                                mfaConfiguration: clientConfig.aws_cognito_mfa_configuration,
                                mfaTypes: clientConfig.aws_cognito_mfa_types,
                                passwordProtectionSettings: {
                                    passwordPolicyMinLength: clientConfig.aws_cognito_password_protection_settings
                                        ?.passwordPolicyMinLength,
                                    passwordPolicyCharacters: clientConfig.aws_cognito_password_protection_settings
                                        ?.passwordPolicyCharacters ?? [],
                                },
                                signupAttributes: clientConfig.aws_cognito_signup_attributes ?? [],
                                usernameAttributes: clientConfig.aws_cognito_username_attributes ?? [],
                                verificationMechanisms: clientConfig.aws_cognito_verification_mechanisms ?? [],
                            },
                        },
                    },
                },
            };
            mobileConfig.auth = authConfig;
        }
        if (clientConfig.aws_appsync_graphqlEndpoint) {
            const apiConfig = {
                plugins: {
                    awsAPIPlugin: {
                        data: {
                            endpointType: 'GraphQL',
                            endpoint: clientConfig.aws_appsync_graphqlEndpoint,
                            region: clientConfig.aws_appsync_region,
                            authorizationType: clientConfig.aws_appsync_authenticationType,
                            apiKey: clientConfig.aws_appsync_apiKey,
                        },
                    },
                },
            };
            mobileConfig.api = apiConfig;
            if (mobileConfig.auth) {
                let defaultClientDatabasePrefix = undefined;
                if (clientConfig.aws_appsync_authenticationType) {
                    defaultClientDatabasePrefix = `data_${clientConfig.aws_appsync_authenticationType}`;
                }
                mobileConfig.auth.plugins.awsCognitoAuthPlugin.AppSync = {
                    Default: {
                        ApiUrl: clientConfig.aws_appsync_graphqlEndpoint,
                        Region: clientConfig.aws_appsync_region,
                        AuthMode: clientConfig.aws_appsync_authenticationType,
                        ApiKey: clientConfig.aws_appsync_apiKey,
                        ClientDatabasePrefix: defaultClientDatabasePrefix,
                    },
                };
                if (clientConfig.aws_appsync_additionalAuthenticationTypes) {
                    for (const additionalAuthenticationType of clientConfig.aws_appsync_additionalAuthenticationTypes.split(',')) {
                        mobileConfig.auth.plugins.awsCognitoAuthPlugin.AppSync[`data_${additionalAuthenticationType}`] = {
                            ApiUrl: clientConfig.aws_appsync_graphqlEndpoint,
                            Region: clientConfig.aws_appsync_region,
                            AuthMode: clientConfig.aws_appsync_authenticationType,
                            ApiKey: clientConfig.aws_appsync_apiKey,
                            ClientDatabasePrefix: `data_${additionalAuthenticationType}`,
                        };
                    }
                }
            }
        }
        if (clientConfig.geo) {
            const geoConfig = {
                plugins: {
                    awsLocationGeoPlugin: {
                        region: clientConfig.geo.amazon_location_service.region,
                    },
                },
            };
            const maps = clientConfig.geo.amazon_location_service.maps;
            if (maps) {
                geoConfig.plugins.awsLocationGeoPlugin.maps = maps;
            }
            const searchIndices = clientConfig.geo.amazon_location_service.search_indices;
            if (searchIndices) {
                geoConfig.plugins.awsLocationGeoPlugin.searchIndices = searchIndices;
            }
            mobileConfig.geo = geoConfig;
        }
        if (clientConfig.Analytics) {
            mobileConfig.analytics = {
                plugins: {
                    awsPinpointAnalyticsPlugin: {
                        pinpointAnalytics: {
                            region: clientConfig.Analytics.AWSPinpoint.region,
                            appId: clientConfig.Analytics.AWSPinpoint.appId,
                        },
                        pinpointTargeting: {
                            region: clientConfig.Analytics.AWSPinpoint.region,
                        },
                    },
                },
            };
        }
        if (clientConfig.Notifications) {
            // APNS and FCM are mapped to the same awsPinpointPushNotificationsPlugin
            // Throw if they're both present but defined differently
            // as this is ambiguous situation
            const fcm = clientConfig.Notifications.FCM;
            const apns = clientConfig.Notifications.APNS;
            if (fcm &&
                apns &&
                (fcm.AWSPinpoint.appId !== apns.AWSPinpoint.appId ||
                    fcm.AWSPinpoint.region !== apns.AWSPinpoint.region)) {
                throw new Error('Cannot convert client config to mobile config if both FCM and APNS are defined with different AWS Pinpoint instance');
            }
            mobileConfig.notifications = {
                plugins: {},
            };
            if (clientConfig.Notifications.SMS) {
                mobileConfig.notifications.plugins.awsPinpointSmsNotificationsPlugin =
                    clientConfig.Notifications.SMS.AWSPinpoint;
            }
            if (clientConfig.Notifications.EMAIL) {
                mobileConfig.notifications.plugins.awsPinpointEmailNotificationsPlugin =
                    clientConfig.Notifications.EMAIL.AWSPinpoint;
            }
            if (clientConfig.Notifications.InAppMessaging) {
                mobileConfig.notifications.plugins.awsPinpointInAppMessagingNotificationsPlugin =
                    clientConfig.Notifications.InAppMessaging.AWSPinpoint;
            }
            // It's fine to overwrite FCM and APNS given validation above.
            if (clientConfig.Notifications.FCM) {
                mobileConfig.notifications.plugins.awsPinpointPushNotificationsPlugin =
                    clientConfig.Notifications.FCM.AWSPinpoint;
            }
            if (clientConfig.Notifications.APNS) {
                mobileConfig.notifications.plugins.awsPinpointPushNotificationsPlugin =
                    clientConfig.Notifications.APNS.AWSPinpoint;
            }
        }
        return mobileConfig;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50X2NvbmZpZ19jb252ZXJ0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY2xpZW50LWNvbmZpZy13cml0ZXIvY2xpZW50X2NvbmZpZ19jb252ZXJ0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBUUE7O0dBRUc7QUFDSCxNQUFNLE9BQU8scUJBQXFCO0lBS2I7SUFDQTtJQUxuQjs7T0FFRztJQUNILFlBQ21CLFdBQW1CLEVBQ25CLGNBQXNCO1FBRHRCLGdCQUFXLEdBQVgsV0FBVyxDQUFRO1FBQ25CLG1CQUFjLEdBQWQsY0FBYyxDQUFRO0lBQ3RDLENBQUM7SUFDSjs7T0FFRztJQUNILHFCQUFxQixHQUFHLENBQUMsWUFBMEIsRUFBc0IsRUFBRTtRQUN6RSxNQUFNLFNBQVMsR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBRS9ELE1BQU0sWUFBWSxHQUF1QjtZQUN2QyxTQUFTLEVBQUUsU0FBUztZQUNwQixPQUFPLEVBQUUsS0FBSztTQUNmLENBQUM7UUFDRixJQUFJLFlBQVksQ0FBQyxpQkFBaUIsRUFBRTtZQUNsQyxNQUFNLFVBQVUsR0FBMkI7Z0JBQ3pDLE9BQU8sRUFBRTtvQkFDUCxvQkFBb0IsRUFBRTt3QkFDcEIsU0FBUyxFQUFFLFNBQVM7d0JBQ3BCLE9BQU8sRUFBRSxLQUFLO3dCQUNkLGVBQWUsRUFBRTs0QkFDZixPQUFPLEVBQUU7Z0NBQ1AsTUFBTSxFQUFFLFlBQVksQ0FBQyxpQkFBaUI7Z0NBQ3RDLFdBQVcsRUFBRSxZQUFZLENBQUMsNEJBQTRCO2dDQUN0RCxNQUFNLEVBQUUsWUFBWSxDQUFDLGtCQUFrQjs2QkFDeEM7eUJBQ0Y7d0JBQ0QsbUJBQW1CLEVBQUU7NEJBQ25CLGVBQWUsRUFBRTtnQ0FDZixPQUFPLEVBQUU7b0NBQ1AsTUFBTSxFQUFFLFlBQVksQ0FBQyw0QkFBNEI7b0NBQ2pELE1BQU0sRUFBRSxZQUFZLENBQUMsa0JBQWtC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QVcsQ0FBQzthQUMvQztTQUNGO1FBRUQsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDbGllbnRDb25maWcgfSBmcm9tICcuLi9jbGllbnQtY29uZmlnLXR5cGVzL2NsaWVudF9jb25maWcuanMnO1xuaW1wb3J0IHtcbiAgQ2xpZW50Q29uZmlnTW9iaWxlLFxuICBDbGllbnRDb25maWdNb2JpbGVBcGksXG4gIENsaWVudENvbmZpZ01vYmlsZUF1dGgsXG4gIENsaWVudENvbmZpZ01vYmlsZUdlbyxcbn0gZnJvbSAnLi4vY2xpZW50LWNvbmZpZy10eXBlcy9tb2JpbGUvY2xpZW50X2NvbmZpZ19tb2JpbGVfdHlwZXMuanMnO1xuXG4vKipcbiAqIENvbnZlcnRzIGNsaWVudCBjb25maWcgdG8gYSBkaWZmZXJlbnQgc2hhcGVzLlxuICovXG5leHBvcnQgY2xhc3MgQ2xpZW50Q29uZmlnQ29udmVydGVyIHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgY2xpZW50IGNvbmZpZyBjb252ZXJ0ZXJcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcGFja2FnZU5hbWU6IHN0cmluZyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhY2thZ2VWZXJzaW9uOiBzdHJpbmdcbiAgKSB7fVxuICAvKipcbiAgICogQ29udmVydHMgY2xpZW50IGNvbmZpZyB0byBhIHNoYXBlIGNvbnN1bWFibGUgYnkgbW9iaWxlIGxpYnJhcmllcy5cbiAgICovXG4gIGNvbnZlcnRUb01vYmlsZUNvbmZpZyA9IChjbGllbnRDb25maWc6IENsaWVudENvbmZpZyk6IENsaWVudENvbmZpZ01vYmlsZSA9PiB7XG4gICAgY29uc3QgdXNlckFnZW50ID0gYCR7dGhpcy5wYWNrYWdlTmFtZX0vJHt0aGlzLnBhY2thZ2VWZXJzaW9ufWA7XG5cbiAgICBjb25zdCBtb2JpbGVDb25maWc6IENsaWVudENvbmZpZ01vYmlsZSA9IHtcbiAgICAgIFVzZXJBZ2VudDogdXNlckFnZW50LFxuICAgICAgVmVyc2lvbjogJzEuMCcsXG4gICAgfTtcbiAgICBpZiAoY2xpZW50Q29uZmlnLmF3c191c2VyX3Bvb2xzX2lkKSB7XG4gICAgICBjb25zdCBhdXRoQ29uZmlnOiBDbGllbnRDb25maWdNb2JpbGVBdXRoID0ge1xuICAgICAgICBwbHVnaW5zOiB7XG4gICAgICAgICAgYXdzQ29nbml0b0F1dGhQbHVnaW46IHtcbiAgICAgICAgICAgIFVzZXJBZ2VudDogdXNlckFnZW50LFxuICAgICAgICAgICAgVmVyc2lvbjogJzEuMCcsXG4gICAgICAgICAgICBDb2duaXRvVXNlclBvb2w6IHtcbiAgICAgICAgICAgICAgRGVmYXVsdDoge1xuICAgICAgICAgICAgICAgIFBvb2xJZDogY2xpZW50Q29uZmlnLmF3c191c2VyX3Bvb2xzX2lkLFxuICAgICAgICAgICAgICAgIEFwcENsaWVudElkOiBjbGllbnRDb25maWcuYXdzX3VzZXJfcG9vbHNfd2ViX2NsaWVudF9pZCxcbiAgICAgICAgICAgICAgICBSZWdpb246IGNsaWVudENvbmZpZy5hd3NfY29nbml0b19yZWdpb24sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgQ3JlZGVudGlhbHNQcm92aWRlcjoge1xuICAgICAgICAgICAgICBDb2duaXRvSWRlbnRpdHk6IHtcbiAgICAgICAgICAgICAgICBEZWZhdWx0OiB7XG4gICAgICAgICAgICAgICAgICBQb29sSWQ6IGNsaWVudENvbmZpZy5hd3NfY29nbml0b19pZGVudGl0eV9wb29sX2lkLFxuICAgICAgICAgICAgICAgICAgUmVnaW9uOiBjbGllbnRDb25maWcuYXdzX2NvZ25pdG9fcmVnaW9uLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgQXV0aDoge1xuICAgICAgICAgICAgICBEZWZhdWx0OiB7XG4gICAgICAgICAgICAgICAgYXV0aGVudGljYXRpb25GbG93VHlwZTogJ1VTRVJfU1JQX0FVVEgnLFxuICAgICAgICAgICAgICAgIG1mYUNvbmZpZ3VyYXRpb246IGNsaWVudENvbmZpZy5hd3NfY29nbml0b19tZmFfY29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICBtZmFUeXBlczogY2xpZW50Q29uZmlnLmF3c19jb2duaXRvX21mYV90eXBlcyxcbiAgICAgICAgICAgICAgICBwYXNzd29yZFByb3RlY3Rpb25TZXR0aW5nczoge1xuICAgICAgICAgICAgICAgICAgcGFzc3dvcmRQb2xpY3lNaW5MZW5ndGg6XG4gICAgICAgICAgICAgICAgICAgIGNsaWVudENvbmZpZy5hd3NfY29nbml0b19wYXNzd29yZF9wcm90ZWN0aW9uX3NldHRpbmdzXG4gICAgICAgICAgICAgICAgICAgICAgPy5wYXNzd29yZFBvbGljeU1pbkxlbmd0aCxcbiAgICAgICAgICAgICAgICAgIHBhc3N3b3JkUG9saWN5Q2hhcmFjdGVyczpcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3Bhc3N3b3JkX3Byb3RlY3Rpb25fc2V0dGluZ3NcbiAgICAgICAgICAgICAgICAgICAgICA/LnBhc3N3b3JkUG9saWN5Q2hhcmFjdGVycyA/PyBbXSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNpZ251cEF0dHJpYnV0ZXM6XG4gICAgICAgICAgICAgICAgICBjbGllbnRDb25maWcuYXdzX2NvZ25pdG9fc2lnbnVwX2F0dHJpYnV0ZXMgPz8gW10sXG4gICAgICAgICAgICAgICAgdXNlcm5hbWVBdHRyaWJ1dGVzOlxuICAgICAgICAgICAgICAgICAgY2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3VzZXJuYW1lX2F0dHJpYnV0ZXMgPz8gW10sXG4gICAgICAgICAgICAgICAgdmVyaWZpY2F0aW9uTWVjaGFuaXNtczpcbiAgICAgICAgICAgICAgICAgIGNsaWVudENvbmZpZy5hd3NfY29nbml0b192ZXJpZmljYXRpb25fbWVjaGFuaXNtcyA/PyBbXSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgICBtb2JpbGVDb25maWcuYXV0aCA9IGF1dGhDb25maWc7XG4gICAgfVxuXG4gICAgaWYgKGNsaWVudENvbmZpZy5hd3NfYXBwc3luY19ncmFwaHFsRW5kcG9pbnQpIHtcbiAgICAgIGNvbnN0IGFwaUNvbmZpZzogQ2xpZW50Q29uZmlnTW9iaWxlQXBpID0ge1xuICAgICAgICBwbHVnaW5zOiB7XG4gICAgICAgICAgYXdzQVBJUGx1Z2luOiB7XG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgIGVuZHBvaW50VHlwZTogJ0dyYXBoUUwnLFxuICAgICAgICAgICAgICBlbmRwb2ludDogY2xpZW50Q29uZmlnLmF3c19hcHBzeW5jX2dyYXBocWxFbmRwb2ludCxcbiAgICAgICAgICAgICAgcmVnaW9uOiBjbGllbnRDb25maWcuYXdzX2FwcHN5bmNfcmVnaW9uLFxuICAgICAgICAgICAgICBhdXRob3JpemF0aW9uVHlwZTogY2xpZW50Q29uZmlnLmF3c19hcHBzeW5jX2F1dGhlbnRpY2F0aW9uVHlwZSxcbiAgICAgICAgICAgICAgYXBpS2V5OiBjbGllbnRDb25maWcuYXdzX2FwcHN5bmNfYXBpS2V5LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIG1vYmlsZUNvbmZpZy5hcGkgPSBhcGlDb25maWc7XG5cbiAgICAgIGlmIChtb2JpbGVDb25maWcuYXV0aCkge1xuICAgICAgICBsZXQgZGVmYXVsdENsaWVudERhdGFiYXNlUHJlZml4ID0gdW5kZWZpbmVkO1xuICAgICAgICBpZiAoY2xpZW50Q29uZmlnLmF3c19hcHBzeW5jX2F1dGhlbnRpY2F0aW9uVHlwZSkge1xuICAgICAgICAgIGRlZmF1bHRDbGllbnREYXRhYmFzZVByZWZpeCA9IGBkYXRhXyR7Y2xpZW50Q29uZmlnLmF3c19hcHBzeW5jX2F1dGhlbnRpY2F0aW9uVHlwZX1gO1xuICAgICAgICB9XG4gICAgICAgIG1vYmlsZUNvbmZpZy5hdXRoLnBsdWdpbnMuYXdzQ29nbml0b0F1dGhQbHVnaW4uQXBwU3luYyA9IHtcbiAgICAgICAgICBEZWZhdWx0OiB7XG4gICAgICAgICAgICBBcGlVcmw6IGNsaWVudENvbmZpZy5hd3NfYXBwc3luY19ncmFwaHFsRW5kcG9pbnQsXG4gICAgICAgICAgICBSZWdpb246IGNsaWVudENvbmZpZy5hd3NfYXBwc3luY19yZWdpb24sXG4gICAgICAgICAgICBBdXRoTW9kZTogY2xpZW50Q29uZmlnLmF3c19hcHBzeW5jX2F1dGhlbnRpY2F0aW9uVHlwZSxcbiAgICAgICAgICAgIEFwaUtleTogY2xpZW50Q29uZmlnLmF3c19hcHBzeW5jX2FwaUtleSxcbiAgICAgICAgICAgIENsaWVudERhdGFiYXNlUHJlZml4OiBkZWZhdWx0Q2xpZW50RGF0YWJhc2VQcmVmaXgsXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKGNsaWVudENvbmZpZy5hd3NfYXBwc3luY19hZGRpdGlvbmFsQXV0aGVudGljYXRpb25UeXBlcykge1xuICAgICAgICAgIGZvciAoY29uc3QgYWRkaXRpb25hbEF1dGhlbnRpY2F0aW9uVHlwZSBvZiBjbGllbnRDb25maWcuYXdzX2FwcHN5bmNfYWRkaXRpb25hbEF1dGhlbnRpY2F0aW9uVHlwZXMuc3BsaXQoXG4gICAgICAgICAgICAnLCdcbiAgICAgICAgICApKSB7XG4gICAgICAgICAgICBtb2JpbGVDb25maWcuYXV0aC5wbHVnaW5zLmF3c0NvZ25pdG9BdXRoUGx1Z2luLkFwcFN5bmNbXG4gICAgICAgICAgICAgIGBkYXRhXyR7YWRkaXRpb25hbEF1dGhlbnRpY2F0aW9uVHlwZX1gXG4gICAgICAgICAgICBdID0ge1xuICAgICAgICAgICAgICBBcGlVcmw6IGNsaWVudENvbmZpZy5hd3NfYXBwc3luY19ncmFwaHFsRW5kcG9pbnQsXG4gICAgICAgICAgICAgIFJlZ2lvbjogY2xpZW50Q29uZmlnLmF3c19hcHBzeW5jX3JlZ2lvbixcbiAgICAgICAgICAgICAgQXV0aE1vZGU6IGNsaWVudENvbmZpZy5hd3NfYXBwc3luY19hdXRoZW50aWNhdGlvblR5cGUsXG4gICAgICAgICAgICAgIEFwaUtleTogY2xpZW50Q29uZmlnLmF3c19hcHBzeW5jX2FwaUtleSxcbiAgICAgICAgICAgICAgQ2xpZW50RGF0YWJhc2VQcmVmaXg6IGBkYXRhXyR7YWRkaXRpb25hbEF1dGhlbnRpY2F0aW9uVHlwZX1gLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY2xpZW50Q29uZmlnLmdlbykge1xuICAgICAgY29uc3QgZ2VvQ29uZmlnOiBDbGllbnRDb25maWdNb2JpbGVHZW8gPSB7XG4gICAgICAgIHBsdWdpbnM6IHtcbiAgICAgICAgICBhd3NMb2NhdGlvbkdlb1BsdWdpbjoge1xuICAgICAgICAgICAgcmVnaW9uOiBjbGllbnRDb25maWcuZ2VvLmFtYXpvbl9sb2NhdGlvbl9zZXJ2aWNlLnJlZ2lvbixcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgY29uc3QgbWFwcyA9IGNsaWVudENvbmZpZy5nZW8uYW1hem9uX2xvY2F0aW9uX3NlcnZpY2UubWFwcztcbiAgICAgIGlmIChtYXBzKSB7XG4gICAgICAgIGdlb0NvbmZpZy5wbHVnaW5zLmF3c0xvY2F0aW9uR2VvUGx1Z2luLm1hcHMgPSBtYXBzO1xuICAgICAgfVxuICAgICAgY29uc3Qgc2VhcmNoSW5kaWNlcyA9XG4gICAgICAgIGNsaWVudENvbmZpZy5nZW8uYW1hem9uX2xvY2F0aW9uX3NlcnZpY2Uuc2VhcmNoX2luZGljZXM7XG4gICAgICBpZiAoc2VhcmNoSW5kaWNlcykge1xuICAgICAgICBnZW9Db25maWcucGx1Z2lucy5hd3NMb2NhdGlvbkdlb1BsdWdpbi5zZWFyY2hJbmRpY2VzID0gc2VhcmNoSW5kaWNlcztcbiAgICAgIH1cblxuICAgICAgbW9iaWxlQ29uZmlnLmdlbyA9IGdlb0NvbmZpZztcbiAgICB9XG5cbiAgICBpZiAoY2xpZW50Q29uZmlnLkFuYWx5dGljcykge1xuICAgICAgbW9iaWxlQ29uZmlnLmFuYWx5dGljcyA9IHtcbiAgICAgICAgcGx1Z2luczoge1xuICAgICAgICAgIGF3c1BpbnBvaW50QW5hbHl0aWNzUGx1Z2luOiB7XG4gICAgICAgICAgICBwaW5wb2ludEFuYWx5dGljczoge1xuICAgICAgICAgICAgICByZWdpb246IGNsaWVudENvbmZpZy5BbmFseXRpY3MuQVdTUGlucG9pbnQucmVnaW9uLFxuICAgICAgICAgICAgICBhcHBJZDogY2xpZW50Q29uZmlnLkFuYWx5dGljcy5BV1NQaW5wb2ludC5hcHBJZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwaW5wb2ludFRhcmdldGluZzoge1xuICAgICAgICAgICAgICByZWdpb246IGNsaWVudENvbmZpZy5BbmFseXRpY3MuQVdTUGlucG9pbnQucmVnaW9uLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoY2xpZW50Q29uZmlnLk5vdGlmaWNhdGlvbnMpIHtcbiAgICAgIC8vIEFQTlMgYW5kIEZDTSBhcmUgbWFwcGVkIHRvIHRoZSBzYW1lIGF3c1BpbnBvaW50UHVzaE5vdGlmaWNhdGlvbnNQbHVnaW5cbiAgICAgIC8vIFRocm93IGlmIHRoZXkncmUgYm90aCBwcmVzZW50IGJ1dCBkZWZpbmVkIGRpZmZlcmVudGx5XG4gICAgICAvLyBhcyB0aGlzIGlzIGFtYmlndW91cyBzaXR1YXRpb25cbiAgICAgIGNvbnN0IGZjbSA9IGNsaWVudENvbmZpZy5Ob3RpZmljYXRpb25zLkZDTTtcbiAgICAgIGNvbnN0IGFwbnMgPSBjbGllbnRDb25maWcuTm90aWZpY2F0aW9ucy5BUE5TO1xuICAgICAgaWYgKFxuICAgICAgICBmY20gJiZcbiAgICAgICAgYXBucyAmJlxuICAgICAgICAoZmNtLkFXU1BpbnBvaW50LmFwcElkICE9PSBhcG5zLkFXU1BpbnBvaW50LmFwcElkIHx8XG4gICAgICAgICAgZmNtLkFXU1BpbnBvaW50LnJlZ2lvbiAhPT0gYXBucy5BV1NQaW5wb2ludC5yZWdpb24pXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdDYW5ub3QgY29udmVydCBjbGllbnQgY29uZmlnIHRvIG1vYmlsZSBjb25maWcgaWYgYm90aCBGQ00gYW5kIEFQTlMgYXJlIGRlZmluZWQgd2l0aCBkaWZmZXJlbnQgQVdTIFBpbnBvaW50IGluc3RhbmNlJ1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgbW9iaWxlQ29uZmlnLm5vdGlmaWNhdGlvbnMgPSB7XG4gICAgICAgIHBsdWdpbnM6IHt9LFxuICAgICAgfTtcbiAgICAgIGlmIChjbGllbnRDb25maWcuTm90aWZpY2F0aW9ucy5TTVMpIHtcbiAgICAgICAgbW9iaWxlQ29uZmlnLm5vdGlmaWNhdGlvbnMucGx1Z2lucy5hd3NQaW5wb2ludFNtc05vdGlmaWNhdGlvbnNQbHVnaW4gPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5Ob3RpZmljYXRpb25zLlNNUy5BV1NQaW5wb2ludDtcbiAgICAgIH1cbiAgICAgIGlmIChjbGllbnRDb25maWcuTm90aWZpY2F0aW9ucy5FTUFJTCkge1xuICAgICAgICBtb2JpbGVDb25maWcubm90aWZpY2F0aW9ucy5wbHVnaW5zLmF3c1BpbnBvaW50RW1haWxOb3RpZmljYXRpb25zUGx1Z2luID1cbiAgICAgICAgICBjbGllbnRDb25maWcuTm90aWZpY2F0aW9ucy5FTUFJTC5BV1NQaW5wb2ludDtcbiAgICAgIH1cbiAgICAgIGlmIChjbGllbnRDb25maWcuTm90aWZpY2F0aW9ucy5JbkFwcE1lc3NhZ2luZykge1xuICAgICAgICBtb2JpbGVDb25maWcubm90aWZpY2F0aW9ucy5wbHVnaW5zLmF3c1BpbnBvaW50SW5BcHBNZXNzYWdpbmdOb3RpZmljYXRpb25zUGx1Z2luID1cbiAgICAgICAgICBjbGllbnRDb25maWcuTm90aWZpY2F0aW9ucy5JbkFwcE1lc3NhZ2luZy5BV1NQaW5wb2ludDtcbiAgICAgIH1cbiAgICAgIC8vIEl0J3MgZmluZSB0byBvdmVyd3JpdGUgRkNNIGFuZCBBUE5TIGdpdmVuIHZhbGlkYXRpb24gYWJvdmUuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLk5vdGlmaWNhdGlvbnMuRkNNKSB7XG4gICAgICAgIG1vYmlsZUNvbmZpZy5ub3RpZmljYXRpb25zLnBsdWdpbnMuYXdzUGlucG9pbnRQdXNoTm90aWZpY2F0aW9uc1BsdWdpbiA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLk5vdGlmaWNhdGlvbnMuRkNNLkFXU1BpbnBvaW50O1xuICAgICAgfVxuICAgICAgaWYgKGNsaWVudENvbmZpZy5Ob3RpZmljYXRpb25zLkFQTlMpIHtcbiAgICAgICAgbW9iaWxlQ29uZmlnLm5vdGlmaWNhdGlvbnMucGx1Z2lucy5hd3NQaW5wb2ludFB1c2hOb3RpZmljYXRpb25zUGx1Z2luID1cbiAgICAgICAgICBjbGllbnRDb25maWcuTm90aWZpY2F0aW9ucy5BUE5TLkFXU1BpbnBvaW50O1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBtb2JpbGVDb25maWc7XG4gIH07XG59XG4iXX0=