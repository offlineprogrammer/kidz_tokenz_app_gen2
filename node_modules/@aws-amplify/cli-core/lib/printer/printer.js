import { color } from '../colors.js';
import { EOL } from 'os';
/**
 * The class that pretty prints to the output stream.
 */
export class Printer {
    minimumLogLevel;
    stdout;
    stderr;
    refreshRate;
    // Properties for ellipsis animation
    timer;
    timerSet;
    /**
     * Sets default configs
     */
    constructor(minimumLogLevel, stdout = process.stdout, stderr = process.stderr, refreshRate = 500) {
        this.minimumLogLevel = minimumLogLevel;
        this.stdout = stdout;
        this.stderr = stderr;
        this.refreshRate = refreshRate;
    }
    /**
     * Prints an array of objects/records to output stream.
     */
    printRecords = (...objects) => {
        for (const obj of objects) {
            this.printRecord(obj);
        }
    };
    /**
     * Prints a given message (with optional color) to output stream.
     */
    print = (message, colorName) => {
        if (colorName) {
            this.stdout.write(color(colorName, message));
        }
        else {
            this.stdout.write(message);
        }
    };
    /**
     * Logs a message with animated ellipsis
     */
    async indicateProgress(message, callback) {
        try {
            this.startAnimatingEllipsis(message);
            await callback();
        }
        finally {
            this.stopAnimatingEllipsis(message);
        }
    }
    /**
     * Prints a new line to output stream
     */
    printNewLine = () => {
        this.stdout.write(EOL);
    };
    /**
     * Logs a message to the output stream.
     */
    log(message, level = LogLevel.INFO, eol = true) {
        const doLogMessage = level <= this.minimumLogLevel;
        if (!doLogMessage) {
            return;
        }
        const logMessage = this.minimumLogLevel === LogLevel.DEBUG
            ? `[${LogLevel[level]}] ${new Date().toISOString()}: ${message}`
            : message;
        if (level === LogLevel.ERROR) {
            this.stderr.write(logMessage);
        }
        else {
            this.stdout.write(logMessage);
        }
        if (eol) {
            this.printNewLine();
        }
    }
    /**
     * Print an object/record to output stream.
     */
    printRecord = (object) => {
        let message = '';
        const entries = Object.entries(object);
        entries.forEach(([key, val]) => {
            message = message.concat(` ${key}: ${val}${EOL}`);
        });
        this.stdout.write(message);
    };
    /**
     * Start animating ellipsis at the end of a log message.
     */
    startAnimatingEllipsis(message) {
        if (!this.isTTY()) {
            this.log(message, LogLevel.INFO);
            return;
        }
        if (this.timerSet) {
            throw new Error('Timer is already set to animate ellipsis, stop the current running timer before starting a new one.');
        }
        const frameLength = 4; // number of desired dots - 1
        let frameCount = 0;
        this.timerSet = true;
        this.writeEscapeSequence(EscapeSequence.HIDE_CURSOR);
        this.stdout.write(message);
        this.timer = setInterval(() => {
            this.writeEscapeSequence(EscapeSequence.CLEAR_LINE);
            this.writeEscapeSequence(EscapeSequence.MOVE_CURSOR_TO_START);
            this.stdout.write(message + '.'.repeat(++frameCount % frameLength));
        }, this.refreshRate);
    }
    /**
     * Stops animating ellipsis and replace with a log message.
     */
    stopAnimatingEllipsis(message) {
        if (!this.isTTY()) {
            return;
        }
        clearInterval(this.timer);
        this.timerSet = false;
        this.writeEscapeSequence(EscapeSequence.CLEAR_LINE);
        this.writeEscapeSequence(EscapeSequence.MOVE_CURSOR_TO_START);
        this.writeEscapeSequence(EscapeSequence.SHOW_CURSOR);
        this.stdout.write(`${message}...${EOL}`);
    }
    /**
     * Writes escape sequence to stdout
     */
    writeEscapeSequence(action) {
        if (!this.isTTY()) {
            return;
        }
        this.stdout.write(action);
    }
    /**
     * Checks if the environment is TTY
     */
    isTTY() {
        return this.stdout.isTTY;
    }
}
export var LogLevel;
(function (LogLevel) {
    LogLevel[LogLevel["ERROR"] = 0] = "ERROR";
    LogLevel[LogLevel["INFO"] = 1] = "INFO";
    LogLevel[LogLevel["DEBUG"] = 2] = "DEBUG";
})(LogLevel || (LogLevel = {}));
var EscapeSequence;
(function (EscapeSequence) {
    EscapeSequence["CLEAR_LINE"] = "\u001B[2K";
    EscapeSequence["MOVE_CURSOR_TO_START"] = "\u001B[0G";
    EscapeSequence["SHOW_CURSOR"] = "\u001B[?25h";
    EscapeSequence["HIDE_CURSOR"] = "\u001B[?25l";
})(EscapeSequence || (EscapeSequence = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wcmludGVyL3ByaW50ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFTLEtBQUssRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUM1QyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBSXpCOztHQUVHO0FBQ0gsTUFBTSxPQUFPLE9BQU87SUFTQztJQUNBO0lBQ0E7SUFDQTtJQVhuQixvQ0FBb0M7SUFDNUIsS0FBSyxDQUFnQztJQUNyQyxRQUFRLENBQVU7SUFFMUI7O09BRUc7SUFDSCxZQUNtQixlQUF5QixFQUN6QixTQUE2QixPQUFPLENBQUMsTUFBTSxFQUMzQyxTQUE2QixPQUFPLENBQUMsTUFBTSxFQUMzQyxjQUFzQixHQUFHO1FBSHpCLG9CQUFlLEdBQWYsZUFBZSxDQUFVO1FBQ3pCLFdBQU0sR0FBTixNQUFNLENBQXFDO1FBQzNDLFdBQU0sR0FBTixNQUFNLENBQXFDO1FBQzNDLGdCQUFXLEdBQVgsV0FBVyxDQUFjO0lBQ3pDLENBQUM7SUFFSjs7T0FFRztJQUNILFlBQVksR0FBRyxDQUNiLEdBQUcsT0FBWSxFQUNULEVBQUU7UUFDUixLQUFLLE1BQU0sR0FBRyxJQUFJLE9BQU8sRUFBRTtZQUN6QixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3ZCO0lBQ0gsQ0FBQyxDQUFDO0lBRUY7O09BRUc7SUFDSCxLQUFLLEdBQUcsQ0FBQyxPQUFlLEVBQUUsU0FBaUIsRUFBRSxFQUFFO1FBQzdDLElBQUksU0FBUyxFQUFFO1lBQ2IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQzlDO2FBQU07WUFDTCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUM1QjtJQUNILENBQUMsQ0FBQztJQUVG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LHlDQUFTLENBQUE7QUFDWCxDQUFDLEVBSlcsUUFBUSxLQUFSLFFBQVEsUUFJbkI7QUFFRCxJQUFLLGNBS0o7QUFMRCxXQUFLLGNBQWM7SUFDakIsMENBQXNCLENBQUE7SUFDdEIsb0RBQWdDLENBQUE7SUFDaEMsNkNBQXlCLENBQUE7SUFDekIsNkNBQXlCLENBQUE7QUFDM0IsQ0FBQyxFQUxJLGNBQWMsS0FBZCxjQUFjLFFBS2xCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ09MT1IsIGNvbG9yIH0gZnJvbSAnLi4vY29sb3JzLmpzJztcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJztcblxuZXhwb3J0IHR5cGUgUmVjb3JkVmFsdWUgPSBzdHJpbmcgfCBudW1iZXIgfCBzdHJpbmdbXSB8IERhdGU7XG5cbi8qKlxuICogVGhlIGNsYXNzIHRoYXQgcHJldHR5IHByaW50cyB0byB0aGUgb3V0cHV0IHN0cmVhbS5cbiAqL1xuZXhwb3J0IGNsYXNzIFByaW50ZXIge1xuICAvLyBQcm9wZXJ0aWVzIGZvciBlbGxpcHNpcyBhbmltYXRpb25cbiAgcHJpdmF0ZSB0aW1lcjogUmV0dXJuVHlwZTx0eXBlb2Ygc2V0VGltZW91dD47XG4gIHByaXZhdGUgdGltZXJTZXQ6IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFNldHMgZGVmYXVsdCBjb25maWdzXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1pbmltdW1Mb2dMZXZlbDogTG9nTGV2ZWwsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdGRvdXQ6IE5vZGVKUy5Xcml0ZVN0cmVhbSA9IHByb2Nlc3Muc3Rkb3V0LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3RkZXJyOiBOb2RlSlMuV3JpdGVTdHJlYW0gPSBwcm9jZXNzLnN0ZGVycixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJlZnJlc2hSYXRlOiBudW1iZXIgPSA1MDBcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBQcmludHMgYW4gYXJyYXkgb2Ygb2JqZWN0cy9yZWNvcmRzIHRvIG91dHB1dCBzdHJlYW0uXG4gICAqL1xuICBwcmludFJlY29yZHMgPSA8VCBleHRlbmRzIFJlY29yZDxzdHJpbmcgfCBudW1iZXIsIFJlY29yZFZhbHVlPj4oXG4gICAgLi4ub2JqZWN0czogVFtdXG4gICk6IHZvaWQgPT4ge1xuICAgIGZvciAoY29uc3Qgb2JqIG9mIG9iamVjdHMpIHtcbiAgICAgIHRoaXMucHJpbnRSZWNvcmQob2JqKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFByaW50cyBhIGdpdmVuIG1lc3NhZ2UgKHdpdGggb3B0aW9uYWwgY29sb3IpIHRvIG91dHB1dCBzdHJlYW0uXG4gICAqL1xuICBwcmludCA9IChtZXNzYWdlOiBzdHJpbmcsIGNvbG9yTmFtZT86IENPTE9SKSA9PiB7XG4gICAgaWYgKGNvbG9yTmFtZSkge1xuICAgICAgdGhpcy5zdGRvdXQud3JpdGUoY29sb3IoY29sb3JOYW1lLCBtZXNzYWdlKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3Rkb3V0LndyaXRlKG1lc3NhZ2UpO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogTG9ncyBhIG1lc3NhZ2Ugd2l0aCBhbmltYXRlZCBlbGxpcHNpc1xuICAgKi9cbiAgYXN5bmMgaW5kaWNhdGVQcm9ncmVzcyhtZXNzYWdlOiBzdHJpbmcsIGNhbGxiYWNrOiAoKSA9PiBQcm9taXNlPHZvaWQ+KSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuc3RhcnRBbmltYXRpbmdFbGxpcHNpcyhtZXNzYWdlKTtcbiAgICAgIGF3YWl0IGNhbGxiYWNrKCk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuc3RvcEFuaW1hdGluZ0VsbGlwc2lzKG1lc3NhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQcmludHMgYSBuZXcgbGluZSB0byBvdXRwdXQgc3RyZWFtXG4gICAqL1xuICBwcmludE5ld0xpbmUgPSAoKSA9PiB7XG4gICAgdGhpcy5zdGRvdXQud3JpdGUoRU9MKTtcbiAgfTtcblxuICAvKipcbiAgICogTG9ncyBhIG1lc3NhZ2UgdG8gdGhlIG91dHB1dCBzdHJlYW0uXG4gICAqL1xuICBsb2cobWVzc2FnZTogc3RyaW5nLCBsZXZlbDogTG9nTGV2ZWwgPSBMb2dMZXZlbC5JTkZPLCBlb2wgPSB0cnVlKSB7XG4gICAgY29uc3QgZG9Mb2dNZXNzYWdlID0gbGV2ZWwgPD0gdGhpcy5taW5pbXVtTG9nTGV2ZWw7XG5cbiAgICBpZiAoIWRvTG9nTWVzc2FnZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGxvZ01lc3NhZ2UgPVxuICAgICAgdGhpcy5taW5pbXVtTG9nTGV2ZWwgPT09IExvZ0xldmVsLkRFQlVHXG4gICAgICAgID8gYFske0xvZ0xldmVsW2xldmVsXX1dICR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpfTogJHttZXNzYWdlfWBcbiAgICAgICAgOiBtZXNzYWdlO1xuXG4gICAgaWYgKGxldmVsID09PSBMb2dMZXZlbC5FUlJPUikge1xuICAgICAgdGhpcy5zdGRlcnIud3JpdGUobG9nTWVzc2FnZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3Rkb3V0LndyaXRlKGxvZ01lc3NhZ2UpO1xuICAgIH1cblxuICAgIGlmIChlb2wpIHtcbiAgICAgIHRoaXMucHJpbnROZXdMaW5lKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFByaW50IGFuIG9iamVjdC9yZWNvcmQgdG8gb3V0cHV0IHN0cmVhbS5cbiAgICovXG4gIHByaXZhdGUgcHJpbnRSZWNvcmQgPSA8VCBleHRlbmRzIFJlY29yZDxzdHJpbmcgfCBudW1iZXIsIFJlY29yZFZhbHVlPj4oXG4gICAgb2JqZWN0OiBUXG4gICk6IHZvaWQgPT4ge1xuICAgIGxldCBtZXNzYWdlID0gJyc7XG4gICAgY29uc3QgZW50cmllcyA9IE9iamVjdC5lbnRyaWVzKG9iamVjdCk7XG4gICAgZW50cmllcy5mb3JFYWNoKChba2V5LCB2YWxdKSA9PiB7XG4gICAgICBtZXNzYWdlID0gbWVzc2FnZS5jb25jYXQoYCAke2tleX06ICR7dmFsIGFzIHN0cmluZ30ke0VPTH1gKTtcbiAgICB9KTtcbiAgICB0aGlzLnN0ZG91dC53cml0ZShtZXNzYWdlKTtcbiAgfTtcblxuICAvKipcbiAgICogU3RhcnQgYW5pbWF0aW5nIGVsbGlwc2lzIGF0IHRoZSBlbmQgb2YgYSBsb2cgbWVzc2FnZS5cbiAgICovXG4gIHByaXZhdGUgc3RhcnRBbmltYXRpbmdFbGxpcHNpcyhtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICBpZiAoIXRoaXMuaXNUVFkoKSkge1xuICAgICAgdGhpcy5sb2cobWVzc2FnZSwgTG9nTGV2ZWwuSU5GTyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudGltZXJTZXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1RpbWVyIGlzIGFscmVhZHkgc2V0IHRvIGFuaW1hdGUgZWxsaXBzaXMsIHN0b3AgdGhlIGN1cnJlbnQgcnVubmluZyB0aW1lciBiZWZvcmUgc3RhcnRpbmcgYSBuZXcgb25lLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgZnJhbWVMZW5ndGggPSA0OyAvLyBudW1iZXIgb2YgZGVzaXJlZCBkb3RzIC0gMVxuICAgIGxldCBmcmFtZUNvdW50ID0gMDtcbiAgICB0aGlzLnRpbWVyU2V0ID0gdHJ1ZTtcbiAgICB0aGlzLndyaXRlRXNjYXBlU2VxdWVuY2UoRXNjYXBlU2VxdWVuY2UuSElERV9DVVJTT1IpO1xuICAgIHRoaXMuc3Rkb3V0LndyaXRlKG1lc3NhZ2UpO1xuICAgIHRoaXMudGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICB0aGlzLndyaXRlRXNjYXBlU2VxdWVuY2UoRXNjYXBlU2VxdWVuY2UuQ0xFQVJfTElORSk7XG4gICAgICB0aGlzLndyaXRlRXNjYXBlU2VxdWVuY2UoRXNjYXBlU2VxdWVuY2UuTU9WRV9DVVJTT1JfVE9fU1RBUlQpO1xuICAgICAgdGhpcy5zdGRvdXQud3JpdGUobWVzc2FnZSArICcuJy5yZXBlYXQoKytmcmFtZUNvdW50ICUgZnJhbWVMZW5ndGgpKTtcbiAgICB9LCB0aGlzLnJlZnJlc2hSYXRlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9wcyBhbmltYXRpbmcgZWxsaXBzaXMgYW5kIHJlcGxhY2Ugd2l0aCBhIGxvZyBtZXNzYWdlLlxuICAgKi9cbiAgcHJpdmF0ZSBzdG9wQW5pbWF0aW5nRWxsaXBzaXMobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzLmlzVFRZKCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjbGVhckludGVydmFsKHRoaXMudGltZXIpO1xuICAgIHRoaXMudGltZXJTZXQgPSBmYWxzZTtcbiAgICB0aGlzLndyaXRlRXNjYXBlU2VxdWVuY2UoRXNjYXBlU2VxdWVuY2UuQ0xFQVJfTElORSk7XG4gICAgdGhpcy53cml0ZUVzY2FwZVNlcXVlbmNlKEVzY2FwZVNlcXVlbmNlLk1PVkVfQ1VSU09SX1RPX1NUQVJUKTtcbiAgICB0aGlzLndyaXRlRXNjYXBlU2VxdWVuY2UoRXNjYXBlU2VxdWVuY2UuU0hPV19DVVJTT1IpO1xuICAgIHRoaXMuc3Rkb3V0LndyaXRlKGAke21lc3NhZ2V9Li4uJHtFT0x9YCk7XG4gIH1cblxuICAvKipcbiAgICogV3JpdGVzIGVzY2FwZSBzZXF1ZW5jZSB0byBzdGRvdXRcbiAgICovXG4gIHByaXZhdGUgd3JpdGVFc2NhcGVTZXF1ZW5jZShhY3Rpb246IEVzY2FwZVNlcXVlbmNlKSB7XG4gICAgaWYgKCF0aGlzLmlzVFRZKCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnN0ZG91dC53cml0ZShhY3Rpb24pO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiB0aGUgZW52aXJvbm1lbnQgaXMgVFRZXG4gICAqL1xuICBwcml2YXRlIGlzVFRZKCkge1xuICAgIHJldHVybiB0aGlzLnN0ZG91dC5pc1RUWTtcbiAgfVxufVxuXG5leHBvcnQgZW51bSBMb2dMZXZlbCB7XG4gIEVSUk9SID0gMCxcbiAgSU5GTyA9IDEsXG4gIERFQlVHID0gMixcbn1cblxuZW51bSBFc2NhcGVTZXF1ZW5jZSB7XG4gIENMRUFSX0xJTkUgPSAnXFx4MWJbMksnLFxuICBNT1ZFX0NVUlNPUl9UT19TVEFSVCA9ICdcXHgxYlswRycsXG4gIFNIT1dfQ1VSU09SID0gJ1xceDFiWz8yNWgnLFxuICBISURFX0NVUlNPUiA9ICdcXHgxYls/MjVsJyxcbn1cbiJdfQ==