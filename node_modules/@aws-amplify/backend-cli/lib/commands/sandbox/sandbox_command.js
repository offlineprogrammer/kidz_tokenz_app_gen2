import fsp from 'fs/promises';
import { AmplifyPrompter } from '@aws-amplify/cli-core';
import { ClientConfigFormat, getClientConfigPath, } from '@aws-amplify/client-config';
import { ClientConfigLifecycleHandler } from '../../client-config/client_config_lifecycle_handler.js';
/**
 * Command that starts sandbox.
 */
export class SandboxCommand {
    sandboxFactory;
    sandboxSubCommands;
    clientConfigGeneratorAdapter;
    commandMiddleware;
    sandboxEventHandlerCreator;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    sandboxName;
    /**
     * Creates sandbox command.
     */
    constructor(sandboxFactory, sandboxSubCommands, clientConfigGeneratorAdapter, commandMiddleware, sandboxEventHandlerCreator) {
        this.sandboxFactory = sandboxFactory;
        this.sandboxSubCommands = sandboxSubCommands;
        this.clientConfigGeneratorAdapter = clientConfigGeneratorAdapter;
        this.commandMiddleware = commandMiddleware;
        this.sandboxEventHandlerCreator = sandboxEventHandlerCreator;
        this.command = 'sandbox';
        this.describe = 'Starts sandbox, watch mode for amplify deployments';
    }
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const sandbox = await this.sandboxFactory.getInstance();
        this.sandboxName = args.name;
        // attaching event handlers
        const clientConfigLifecycleHandler = new ClientConfigLifecycleHandler(this.clientConfigGeneratorAdapter, args['config-out-dir'], args['config-format']);
        const eventHandlers = this.sandboxEventHandlerCreator?.({
            sandboxName: this.sandboxName,
            clientConfigLifecycleHandler,
        });
        if (eventHandlers) {
            Object.entries(eventHandlers).forEach(([event, handlers]) => {
                handlers.forEach((handler) => sandbox.on(event, handler));
            });
        }
        const watchExclusions = args.exclude ?? [];
        const clientConfigWritePath = await getClientConfigPath(args['config-out-dir'], args['config-format']);
        watchExclusions.push(clientConfigWritePath);
        await sandbox.start({
            dir: args['dir-to-watch'],
            exclude: watchExclusions,
            name: args.name,
            profile: args.profile,
        });
        process.once('SIGINT', () => void this.sigIntHandler());
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return (yargs
            // Cast to erase options types used in internal sub command implementation. Otherwise, compiler fails here.
            .command(this.sandboxSubCommands)
            .version(false)
            .option('dir-to-watch', {
            describe: 'Directory to watch for file changes. All subdirectories and files will be included. defaults to the current directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('exclude', {
            describe: 'An array of paths or glob patterns to ignore. Paths can be relative or absolute and can either be files or directories',
            type: 'string',
            array: true,
            global: false,
        })
            .option('name', {
            describe: 'An optional name to distinguish between different sandbox environments. Default is the name in your package.json',
            type: 'string',
            array: false,
            global: false,
        })
            .option('config-format', {
            describe: 'Client config output format',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigFormat),
            global: false,
        })
            .option('config-out-dir', {
            describe: 'A path to directory where config is written. If not provided defaults to current process working directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('profile', {
            describe: 'An AWS profile name.',
            type: 'string',
            array: false,
        })
            .check(async (argv) => {
            if (argv['dir-to-watch']) {
                await this.validateDirectory('dir-to-watch', argv['dir-to-watch']);
            }
            if (argv['config-out-dir']) {
                await this.validateDirectory('config-out-dir', argv['config-out-dir']);
            }
            if (argv.name) {
                const projectNameRegex = /^[a-zA-Z0-9-]{1,15}$/;
                if (!argv.name.match(projectNameRegex)) {
                    throw new Error(`--name should match [a-zA-Z0-9-] and less than 15 characters.`);
                }
            }
            return true;
        })
            .middleware([this.commandMiddleware.ensureAwsCredentialAndRegion]));
    };
    sigIntHandler = async () => {
        const answer = await AmplifyPrompter.yesOrNo({
            message: 'Would you like to delete all the resources in your sandbox environment (This cannot be undone)?',
            defaultValue: false,
        });
        if (answer)
            await (await this.sandboxFactory.getInstance()).delete({ name: this.sandboxName });
    };
    validateDirectory = async (option, dir) => {
        let stats;
        try {
            stats = await fsp.stat(dir, {});
        }
        catch (e) {
            throw new Error(`--${option} ${dir} does not exist`);
        }
        if (!stats.isDirectory()) {
            throw new Error(`--${option} ${dir} is not a valid directory`);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveF9jb21tYW5kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL3NhbmRib3gvc2FuZGJveF9jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sR0FBRyxNQUFNLGFBQWEsQ0FBQztBQUM5QixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFeEQsT0FBTyxFQUNMLGtCQUFrQixFQUNsQixtQkFBbUIsR0FDcEIsTUFBTSw0QkFBNEIsQ0FBQztBQUVwQyxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQWlDdEc7O0dBRUc7QUFDSCxNQUFNLE9BQU8sY0FBYztJQW1CTjtJQUNBO0lBQ1Q7SUFDQTtJQUNTO0lBcEJuQjs7T0FFRztJQUNNLE9BQU8sQ0FBUztJQUV6Qjs7T0FFRztJQUNNLFFBQVEsQ0FBUztJQUVsQixXQUFXLENBQVU7SUFFN0I7O09BRUc7SUFDSCxZQUNtQixjQUF1QyxFQUN2QyxrQkFBbUMsRUFDNUMsNEJBQTBELEVBQzFELGlCQUFvQyxFQUMzQiwwQkFBdUQ7UUFKdkQsbUJBQWMsR0FBZCxjQUFjLENBQXlCO1FBQ3ZDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBaUI7UUFDNUMsaUNBQTRCLEdBQTVCLDRCQUE0QixDQUE4QjtRQUMxRCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQzNCLCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBNkI7UUFFeEUsSUFBSSxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUM7UUFDekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxvREFBb0QsQ0FBQztJQUN2RSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQUFPLEdBQUcsS0FBSyxFQUFFLElBQTJCLEVBQWlCLEVBQUU7UUFDN0QsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3hELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUU3QiwyQkFBMkI7UUFDM0IsTUFBTSw0QkFBNEIsR0FBRyxJQUFJLDRCQUE0QixDQUNuRSxJQUFJLENBQUMsNEJBQTRCLEVBQ2pDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUN0QixJQUFJLENBQUMsZUFBZSxDQUFDLENBQ3RCLENBQUM7UUFDRixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztZQUN0RCxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsNEJBQTRCO1NBQzdCLENBQUMsQ0FBQztRQUNILElBQUksYUFBYSxFQUFFO1lBQ2pCLE1BQU0sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLEVBQUUsRUFBRTtnQkFDMUQsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUM1RCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDM0MsTUFBTSxxQkFBcUIsR0FBRyxNQUFNLG1CQUFtQixDQUNyRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsRUFDdEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUN0QixDQUFDO1FBQ0YsZUFBZSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQzVDLE1BQU0sT0FBTyxDQUFDLEtBQUssQ0FBQztZQUNsQixHQUFHLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUN6QixPQUFPLEVBQUUsZUFBZTtZQUN4QixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87U0FDdEIsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQztJQUMxRCxDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILE9BQU8sR0FBRyxDQUFDLEtBQVcsRUFBK0IsRUFBRTtRQUNyRCxPQUFPLENBQ0wsS0FBSztZQUNILDJHQUEyRzthQUMxRyxPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDO2FBQ2hDLE9BQU8sQ0FBQyxLQUFLLENBQUM7YUFDZCxNQUFNLENBQUMsY0FBYyxFQUFFO1lBQ3RCLFFBQVEsRUFDTix3SEFBd0g7WUFDMUgsSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztZQUNaLE1BQU0sRUFBRSxLQUFLO1NBQ2QsQ0FBQzthQUNELE1BQU0sQ0FBQyxTQUFTLEVBQUU7WUFDakIsUUFBUSxFQUNOLHdIQUF3SDtZQUMxSCxJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxJQUFJO1lBQ1gsTUFBTSxFQUFFLEtBQUs7U0FDZCxDQUFDO2FBQ0QsTUFBTSxDQUFDLE1BQU0sRUFBRTtZQUNkLFFBQVEsRUFDTixrSEFBa0g7WUFDcEgsSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztZQUNaLE1BQU0sRUFBRSxLQUFLO1NBQ2QsQ0FBQzthQUNELE1BQU0sQ0FBQyxlQUFlLEVBQUU7WUFDdkIsUUFBUSxFQUFFLDZCQUE2QjtZQUN2QyxJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1lBQ1osT0FBTyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUM7WUFDMUMsTUFBTSxFQUFFLEtBQUs7U0FDZCxDQUFDO2FBQ0QsTUFBTSxDQUFDLGdCQUFnQixFQUFFO1lBQ3hCLFFBQVEsRUFDTiw2R0FBNkc7WUFDL0csSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztZQUNaLE1BQU0sRUFBRSxLQUFLO1NBQ2QsQ0FBQzthQUNELE1BQU0sQ0FBQyxTQUFTLEVBQUU7WUFDakIsUUFBUSxFQUFFLHNCQUFzQjtZQUNoQyxJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1NBQ2IsQ0FBQzthQUNELEtBQUssQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDcEIsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUU7Z0JBQ3hCLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQzthQUNwRTtZQUNELElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUU7Z0JBQzFCLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUMxQixnQkFBZ0IsRUFDaEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQ3ZCLENBQUM7YUFDSDtZQUNELElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDYixNQUFNLGdCQUFnQixHQUFHLHNCQUFzQixDQUFDO2dCQUNoRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtvQkFDdEMsTUFBTSxJQUFJLEtBQUssQ0FDYiwrREFBK0QsQ0FDaEUsQ0FBQztpQkFDSDthQUNGO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDLENBQUM7YUFDRCxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxDQUNyRSxDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRUYsYUFBYSxHQUFHLEtBQUssSUFBSSxFQUFFO1FBQ3pCLE1BQU0sTUFBTSxHQUFHLE1BQU0sZUFBZSxDQUFDLE9BQU8sQ0FBQztZQUMzQyxPQUFPLEVBQ0wsaUdBQWlHO1lBQ25HLFlBQVksRUFBRSxLQUFLO1NBQ3BCLENBQUMsQ0FBQztRQUNILElBQUksTUFBTTtZQUNSLE1BQU0sQ0FDSixNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQ3hDLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQ3pDLENBQUMsQ0FBQztJQUVNLGlCQUFpQixHQUFHLEtBQUssRUFBRSxNQUFjLEVBQUUsR0FBVyxFQUFFLEVBQUU7UUFDaEUsSUFBSSxLQUFLLENBQUM7UUFDVixJQUFJO1lBQ0YsS0FBSyxHQUFHLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDakM7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsS0FBSyxNQUFNLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxDQUFDO1NBQ3REO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUN4QixNQUFNLElBQUksS0FBSyxDQUFDLEtBQUssTUFBTSxJQUFJLEdBQUcsMkJBQTJCLENBQUMsQ0FBQztTQUNoRTtJQUNILENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXJndiwgQ29tbWFuZE1vZHVsZSB9IGZyb20gJ3lhcmdzJztcbmltcG9ydCBmc3AgZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHsgQW1wbGlmeVByb21wdGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NsaS1jb3JlJztcbmltcG9ydCB7IFNhbmRib3hTaW5nbGV0b25GYWN0b3J5IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3NhbmRib3gnO1xuaW1wb3J0IHtcbiAgQ2xpZW50Q29uZmlnRm9ybWF0LFxuICBnZXRDbGllbnRDb25maWdQYXRoLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvY2xpZW50LWNvbmZpZyc7XG5pbXBvcnQgeyBBcmd1bWVudHNLZWJhYkNhc2UgfSBmcm9tICcuLi8uLi9rZWJhYl9jYXNlLmpzJztcbmltcG9ydCB7IENsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIgfSBmcm9tICcuLi8uLi9jbGllbnQtY29uZmlnL2NsaWVudF9jb25maWdfbGlmZWN5Y2xlX2hhbmRsZXIuanMnO1xuaW1wb3J0IHsgQ2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlciB9IGZyb20gJy4uLy4uL2NsaWVudC1jb25maWcvY2xpZW50X2NvbmZpZ19nZW5lcmF0b3JfYWRhcHRlci5qcyc7XG5pbXBvcnQgeyBDb21tYW5kTWlkZGxld2FyZSB9IGZyb20gJy4uLy4uL2NvbW1hbmRfbWlkZGxld2FyZS5qcyc7XG5cbmV4cG9ydCB0eXBlIFNhbmRib3hDb21tYW5kT3B0aW9ucyA9XG4gIEFyZ3VtZW50c0tlYmFiQ2FzZTxTYW5kYm94Q29tbWFuZE9wdGlvbnNDYW1lbENhc2U+O1xuXG50eXBlIFNhbmRib3hDb21tYW5kT3B0aW9uc0NhbWVsQ2FzZSA9IHtcbiAgZGlyVG9XYXRjaDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBleGNsdWRlOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgbmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBjb25maWdGb3JtYXQ6IENsaWVudENvbmZpZ0Zvcm1hdCB8IHVuZGVmaW5lZDtcbiAgY29uZmlnT3V0RGlyOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIHByb2ZpbGU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbn07XG5cbmV4cG9ydCB0eXBlIEV2ZW50SGFuZGxlciA9ICguLi5hcmdzOiB1bmtub3duW10pID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIFNhbmRib3hFdmVudEhhbmRsZXJzID0ge1xuICBzdWNjZXNzZnVsRGVwbG95bWVudDogRXZlbnRIYW5kbGVyW107XG4gIHN1Y2Nlc3NmdWxEZWxldGlvbjogRXZlbnRIYW5kbGVyW107XG4gIGZhaWxlZERlcGxveW1lbnQ6IEV2ZW50SGFuZGxlcltdO1xufTtcblxuZXhwb3J0IHR5cGUgU2FuZGJveEV2ZW50SGFuZGxlclBhcmFtcyA9IHtcbiAgc2FuZGJveE5hbWU/OiBzdHJpbmc7XG4gIGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXI6IENsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXI7XG59O1xuXG5leHBvcnQgdHlwZSBTYW5kYm94RXZlbnRIYW5kbGVyQ3JlYXRvciA9IChcbiAgcGFyYW1zOiBTYW5kYm94RXZlbnRIYW5kbGVyUGFyYW1zXG4pID0+IFNhbmRib3hFdmVudEhhbmRsZXJzO1xuXG4vKipcbiAqIENvbW1hbmQgdGhhdCBzdGFydHMgc2FuZGJveC5cbiAqL1xuZXhwb3J0IGNsYXNzIFNhbmRib3hDb21tYW5kXG4gIGltcGxlbWVudHMgQ29tbWFuZE1vZHVsZTxvYmplY3QsIFNhbmRib3hDb21tYW5kT3B0aW9ucz5cbntcbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBjb21tYW5kOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBkZXNjcmliZTogc3RyaW5nO1xuXG4gIHByaXZhdGUgc2FuZGJveE5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgc2FuZGJveCBjb21tYW5kLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBzYW5kYm94RmFjdG9yeTogU2FuZGJveFNpbmdsZXRvbkZhY3RvcnksXG4gICAgcHJpdmF0ZSByZWFkb25seSBzYW5kYm94U3ViQ29tbWFuZHM6IENvbW1hbmRNb2R1bGVbXSxcbiAgICBwcml2YXRlIGNsaWVudENvbmZpZ0dlbmVyYXRvckFkYXB0ZXI6IENsaWVudENvbmZpZ0dlbmVyYXRvckFkYXB0ZXIsXG4gICAgcHJpdmF0ZSBjb21tYW5kTWlkZGxld2FyZTogQ29tbWFuZE1pZGRsZXdhcmUsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzYW5kYm94RXZlbnRIYW5kbGVyQ3JlYXRvcj86IFNhbmRib3hFdmVudEhhbmRsZXJDcmVhdG9yXG4gICkge1xuICAgIHRoaXMuY29tbWFuZCA9ICdzYW5kYm94JztcbiAgICB0aGlzLmRlc2NyaWJlID0gJ1N0YXJ0cyBzYW5kYm94LCB3YXRjaCBtb2RlIGZvciBhbXBsaWZ5IGRlcGxveW1lbnRzJztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgaGFuZGxlciA9IGFzeW5jIChhcmdzOiBTYW5kYm94Q29tbWFuZE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCBzYW5kYm94ID0gYXdhaXQgdGhpcy5zYW5kYm94RmFjdG9yeS5nZXRJbnN0YW5jZSgpO1xuICAgIHRoaXMuc2FuZGJveE5hbWUgPSBhcmdzLm5hbWU7XG5cbiAgICAvLyBhdHRhY2hpbmcgZXZlbnQgaGFuZGxlcnNcbiAgICBjb25zdCBjbGllbnRDb25maWdMaWZlY3ljbGVIYW5kbGVyID0gbmV3IENsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIoXG4gICAgICB0aGlzLmNsaWVudENvbmZpZ0dlbmVyYXRvckFkYXB0ZXIsXG4gICAgICBhcmdzWydjb25maWctb3V0LWRpciddLFxuICAgICAgYXJnc1snY29uZmlnLWZvcm1hdCddXG4gICAgKTtcbiAgICBjb25zdCBldmVudEhhbmRsZXJzID0gdGhpcy5zYW5kYm94RXZlbnRIYW5kbGVyQ3JlYXRvcj8uKHtcbiAgICAgIHNhbmRib3hOYW1lOiB0aGlzLnNhbmRib3hOYW1lLFxuICAgICAgY2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcixcbiAgICB9KTtcbiAgICBpZiAoZXZlbnRIYW5kbGVycykge1xuICAgICAgT2JqZWN0LmVudHJpZXMoZXZlbnRIYW5kbGVycykuZm9yRWFjaCgoW2V2ZW50LCBoYW5kbGVyc10pID0+IHtcbiAgICAgICAgaGFuZGxlcnMuZm9yRWFjaCgoaGFuZGxlcikgPT4gc2FuZGJveC5vbihldmVudCwgaGFuZGxlcikpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IHdhdGNoRXhjbHVzaW9ucyA9IGFyZ3MuZXhjbHVkZSA/PyBbXTtcbiAgICBjb25zdCBjbGllbnRDb25maWdXcml0ZVBhdGggPSBhd2FpdCBnZXRDbGllbnRDb25maWdQYXRoKFxuICAgICAgYXJnc1snY29uZmlnLW91dC1kaXInXSxcbiAgICAgIGFyZ3NbJ2NvbmZpZy1mb3JtYXQnXVxuICAgICk7XG4gICAgd2F0Y2hFeGNsdXNpb25zLnB1c2goY2xpZW50Q29uZmlnV3JpdGVQYXRoKTtcbiAgICBhd2FpdCBzYW5kYm94LnN0YXJ0KHtcbiAgICAgIGRpcjogYXJnc1snZGlyLXRvLXdhdGNoJ10sXG4gICAgICBleGNsdWRlOiB3YXRjaEV4Y2x1c2lvbnMsXG4gICAgICBuYW1lOiBhcmdzLm5hbWUsXG4gICAgICBwcm9maWxlOiBhcmdzLnByb2ZpbGUsXG4gICAgfSk7XG4gICAgcHJvY2Vzcy5vbmNlKCdTSUdJTlQnLCAoKSA9PiB2b2lkIHRoaXMuc2lnSW50SGFuZGxlcigpKTtcbiAgfTtcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIGJ1aWxkZXIgPSAoeWFyZ3M6IEFyZ3YpOiBBcmd2PFNhbmRib3hDb21tYW5kT3B0aW9ucz4gPT4ge1xuICAgIHJldHVybiAoXG4gICAgICB5YXJnc1xuICAgICAgICAvLyBDYXN0IHRvIGVyYXNlIG9wdGlvbnMgdHlwZXMgdXNlZCBpbiBpbnRlcm5hbCBzdWIgY29tbWFuZCBpbXBsZW1lbnRhdGlvbi4gT3RoZXJ3aXNlLCBjb21waWxlciBmYWlscyBoZXJlLlxuICAgICAgICAuY29tbWFuZCh0aGlzLnNhbmRib3hTdWJDb21tYW5kcylcbiAgICAgICAgLnZlcnNpb24oZmFsc2UpXG4gICAgICAgIC5vcHRpb24oJ2Rpci10by13YXRjaCcsIHtcbiAgICAgICAgICBkZXNjcmliZTpcbiAgICAgICAgICAgICdEaXJlY3RvcnkgdG8gd2F0Y2ggZm9yIGZpbGUgY2hhbmdlcy4gQWxsIHN1YmRpcmVjdG9yaWVzIGFuZCBmaWxlcyB3aWxsIGJlIGluY2x1ZGVkLiBkZWZhdWx0cyB0byB0aGUgY3VycmVudCBkaXJlY3RvcnkuJyxcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignZXhjbHVkZScsIHtcbiAgICAgICAgICBkZXNjcmliZTpcbiAgICAgICAgICAgICdBbiBhcnJheSBvZiBwYXRocyBvciBnbG9iIHBhdHRlcm5zIHRvIGlnbm9yZS4gUGF0aHMgY2FuIGJlIHJlbGF0aXZlIG9yIGFic29sdXRlIGFuZCBjYW4gZWl0aGVyIGJlIGZpbGVzIG9yIGRpcmVjdG9yaWVzJyxcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICBhcnJheTogdHJ1ZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCduYW1lJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0FuIG9wdGlvbmFsIG5hbWUgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiBkaWZmZXJlbnQgc2FuZGJveCBlbnZpcm9ubWVudHMuIERlZmF1bHQgaXMgdGhlIG5hbWUgaW4geW91ciBwYWNrYWdlLmpzb24nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdjb25maWctZm9ybWF0Jywge1xuICAgICAgICAgIGRlc2NyaWJlOiAnQ2xpZW50IGNvbmZpZyBvdXRwdXQgZm9ybWF0JyxcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgICAgY2hvaWNlczogT2JqZWN0LnZhbHVlcyhDbGllbnRDb25maWdGb3JtYXQpLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ2NvbmZpZy1vdXQtZGlyJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0EgcGF0aCB0byBkaXJlY3Rvcnkgd2hlcmUgY29uZmlnIGlzIHdyaXR0ZW4uIElmIG5vdCBwcm92aWRlZCBkZWZhdWx0cyB0byBjdXJyZW50IHByb2Nlc3Mgd29ya2luZyBkaXJlY3RvcnkuJyxcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbigncHJvZmlsZScsIHtcbiAgICAgICAgICBkZXNjcmliZTogJ0FuIEFXUyBwcm9maWxlIG5hbWUuJyxcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5jaGVjayhhc3luYyAoYXJndikgPT4ge1xuICAgICAgICAgIGlmIChhcmd2WydkaXItdG8td2F0Y2gnXSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy52YWxpZGF0ZURpcmVjdG9yeSgnZGlyLXRvLXdhdGNoJywgYXJndlsnZGlyLXRvLXdhdGNoJ10pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoYXJndlsnY29uZmlnLW91dC1kaXInXSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy52YWxpZGF0ZURpcmVjdG9yeShcbiAgICAgICAgICAgICAgJ2NvbmZpZy1vdXQtZGlyJyxcbiAgICAgICAgICAgICAgYXJndlsnY29uZmlnLW91dC1kaXInXVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGFyZ3YubmFtZSkge1xuICAgICAgICAgICAgY29uc3QgcHJvamVjdE5hbWVSZWdleCA9IC9eW2EtekEtWjAtOS1dezEsMTV9JC87XG4gICAgICAgICAgICBpZiAoIWFyZ3YubmFtZS5tYXRjaChwcm9qZWN0TmFtZVJlZ2V4KSkge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgYC0tbmFtZSBzaG91bGQgbWF0Y2ggW2EtekEtWjAtOS1dIGFuZCBsZXNzIHRoYW4gMTUgY2hhcmFjdGVycy5gXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KVxuICAgICAgICAubWlkZGxld2FyZShbdGhpcy5jb21tYW5kTWlkZGxld2FyZS5lbnN1cmVBd3NDcmVkZW50aWFsQW5kUmVnaW9uXSlcbiAgICApO1xuICB9O1xuXG4gIHNpZ0ludEhhbmRsZXIgPSBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgYW5zd2VyID0gYXdhaXQgQW1wbGlmeVByb21wdGVyLnllc09yTm8oe1xuICAgICAgbWVzc2FnZTpcbiAgICAgICAgJ1dvdWxkIHlvdSBsaWtlIHRvIGRlbGV0ZSBhbGwgdGhlIHJlc291cmNlcyBpbiB5b3VyIHNhbmRib3ggZW52aXJvbm1lbnQgKFRoaXMgY2Fubm90IGJlIHVuZG9uZSk/JyxcbiAgICAgIGRlZmF1bHRWYWx1ZTogZmFsc2UsXG4gICAgfSk7XG4gICAgaWYgKGFuc3dlcilcbiAgICAgIGF3YWl0IChcbiAgICAgICAgYXdhaXQgdGhpcy5zYW5kYm94RmFjdG9yeS5nZXRJbnN0YW5jZSgpXG4gICAgICApLmRlbGV0ZSh7IG5hbWU6IHRoaXMuc2FuZGJveE5hbWUgfSk7XG4gIH07XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZURpcmVjdG9yeSA9IGFzeW5jIChvcHRpb246IHN0cmluZywgZGlyOiBzdHJpbmcpID0+IHtcbiAgICBsZXQgc3RhdHM7XG4gICAgdHJ5IHtcbiAgICAgIHN0YXRzID0gYXdhaXQgZnNwLnN0YXQoZGlyLCB7fSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAtLSR7b3B0aW9ufSAke2Rpcn0gZG9lcyBub3QgZXhpc3RgKTtcbiAgICB9XG4gICAgaWYgKCFzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYC0tJHtvcHRpb259ICR7ZGlyfSBpcyBub3QgYSB2YWxpZCBkaXJlY3RvcnlgKTtcbiAgICB9XG4gIH07XG59XG4iXX0=